<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.Y COIN Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        .tooltip-text { visibility: hidden; width: 300px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 100; top: 100%; left: 50%; margin-left: -150px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.3); pointer-events: none; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .toggle-checkbox:checked { right: 0; border-color: #4F46E5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4F46E5; }
    </style>
</head>
<body class="p-6">

    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-chart-line text-indigo-600 mr-2"></i>
                    <span data-lang="title">S.A.Y COIN Dashboard</span>
                </h1>
            </div>
            <div class="flex items-center gap-2 mt-1">
                <p class="text-gray-500 text-sm" data-lang="subtitle">서버 저장 없는 실시간 로컬 분석</p>
                <div class="relative tooltip-container cursor-help">
                    <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500"></i>
                    <div class="tooltip-text">
                        <strong class="block mb-1 text-yellow-400">[보안 아키텍처 설명]</strong>
                        1. <strong>개인정보 보호:</strong> 이름, 여권번호 등 민감한 마스터 데이터는 외부 서버에 저장되지 않습니다.<br>
                        2. <strong>로컬 처리:</strong> 브라우저 내부 저장소(IndexedDB)에 안전하게 격리되어 저장됩니다.<br>
                        3. <strong>작동 원리:</strong> 서버의 '익명 로그'와 내 PC의 '실명 정보'가 브라우저 메모리 상에서 결합됩니다.
                    </div>
                </div>
            </div>
        </div>
        <div class="flex gap-2 flex-wrap justify-end">
            <button onclick="toggleLanguage()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow font-bold">
                <i class="fas fa-globe mr-2"></i><span id="langBtnText">EN</span>
            </button>
            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
                <i class="fas fa-sync-alt mr-2"></i><span data-lang="refresh">데이터 갱신</span>
            </button>
            <button onclick="toggleModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow">
                <i class="fas fa-file-import mr-2"></i><span data-lang="btn_upload">마스터정보 입력</span>
            </button>
            <button onclick="downloadExcel()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">
                <i class="fas fa-download mr-2"></i><span data-lang="btn_download">Excel Download</span>
            </button>
        </div>
    </header>

    <div id="loading" class="text-center py-20">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i>
        <p class="mt-4 text-gray-600" data-lang="loading">데이터 불러오는 중...</p>
    </div>

    <div id="dashboard" class="hidden space-y-8">
        
        <div id="statusBanner" class="hidden p-4 mb-4 flex justify-between items-center border-l-4 rounded bg-gray-50">
            </div>

        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2"><i class="far fa-calendar-alt mr-1"></i> <span data-lang="sect_month">이번 달 현황</span></h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="card p-6 border-l-4 border-blue-400">
                <p class="text-gray-500 text-sm" data-lang="card_issued_month">이번 달 지급</p>
                <h2 class="text-3xl font-bold text-gray-800" id="monthIssued">-</h2>
            </div>
            <div class="card p-6 border-l-4 border-red-400">
                <p class="text-gray-500 text-sm" data-lang="card_used_month">이번 달 사용</p>
                <h2 class="text-3xl font-bold text-gray-800" id="monthUsed">-</h2>
            </div>
        </div>

        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2"><i class="fas fa-history mr-1"></i> <span data-lang="sect_total">전체 누적 현황</span></h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="card p-6 border-l-4 border-blue-600">
                <p class="text-gray-500 text-sm" data-lang="card_issued">총 지급 코인</p>
                <h2 class="text-3xl font-bold text-gray-800" id="totalIssued">-</h2>
            </div>
            <div class="card p-6 border-l-4 border-red-600">
                <p class="text-gray-500 text-sm" data-lang="card_used">총 사용(회수) 코인</p>
                <h2 class="text-3xl font-bold text-gray-800" id="totalUsed">-</h2>
            </div>
            <div class="card p-6 border-l-4 border-green-600">
                <p class="text-gray-500 text-sm" data-lang="card_remain">시중 유통량</p>
                <h2 class="text-3xl font-bold text-gray-800" id="currentCirculation">-</h2>
            </div>
            <div class="card p-6 border-l-4 border-purple-600">
                <p class="text-gray-500 text-sm" data-lang="card_rate">코인 회수율</p>
                <h2 class="text-3xl font-bold text-gray-800" id="returnRate">-</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 relative">
            
            <div class="lg:col-span-3 flex justify-end">
                <div class="inline-flex bg-gray-200 rounded-lg p-1">
                    <button onclick="setChartMode('all')" id="btnAll" class="px-4 py-1 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition">All Time</button>
                    <button onclick="setChartMode('month')" id="btnMonth" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition">This Month</button>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_general">일반 지급 사유</h3>
                <canvas id="chartGeneral"></canvas>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_hse">HSE 지급 사유</h3>
                <canvas id="chartHSE"></canvas>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_holdings">협력사별 코인 보유 비율</h3>
                <div class="h-64 flex justify-center">
                    <canvas id="chartHoldings"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_trend_worker">협력사별 코인 지급 추세(근로자)</h3>
                <div class="h-80">
                    <canvas id="chartTrend"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_cumulative">협력사별 지급 누적량 (Cumulative)</h3>
                <div class="h-80">
                    <canvas id="chartCumulative"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card p-6">
            <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="table_title">협력사 코인 지급 추세(업체)</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3" data-lang="th_name">협력사명</th>
                            <th class="px-6 py-3 text-right" data-lang="th_give">총 지급 (Give)</th>
                            <th class="px-6 py-3 text-right" data-lang="th_use">총 사용 (Use)</th>
                            <th class="px-6 py-3 text-right font-bold" data-lang="th_balance">현재 잔액</th>
                        </tr>
                    </thead>
                    <tbody id="subconTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold" data-lang="modal_title">마스터 정보 로컬 저장</p>
                    <div class="cursor-pointer z-50" onclick="toggleModal()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="bg-blue-50 p-3 rounded mb-3 text-sm text-blue-800">
                    <i class="fas fa-hdd mr-2"></i>
                    <span data-lang="modal_security">데이터는 서버로 전송되지 않고 내 PC(IndexedDB)에만 저장됩니다.</span>
                </div>
                <p class="text-sm text-gray-500 mb-2" data-lang="modal_desc">
                    엑셀의 [Passport, Company, Name, Designation] 4개 열을 복사해 붙여넣으세요.
                </p>
                <textarea id="pasteArea" class="w-full h-64 p-2 border rounded bg-gray-50 text-xs font-mono" placeholder="A1234567 | SEC | Hong Gil Dong | Manager&#10;..."></textarea>
                <div class="flex justify-end pt-4 gap-2">
                    <button onclick="toggleModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" data-lang="btn_close">닫기</button>
                    <button onclick="saveToIndexedDB()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700" data-lang="btn_save">저장하기</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [설정] 배포된 GAS URL
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxVF66kP7qUr092RVdsXctYztfGVtszSuWJmLKa9Ak6-FTR47jgoLif9EYbC-xaFYGo/exec"; 

        // State
        let currentLang = 'ko';
        let chartMode = 'all'; // 'all' or 'month'
        let cachedData = null;      
        let localMasterMap = {};    
        let charts = {};

        // --- IndexedDB Class ---
        class MasterDB {
            constructor() { this.dbName = 'SayCoinMasterDB'; this.storeName = 'workers'; this.db = null; }
            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) db.createObjectStore(this.storeName, { keyPath: 'passport' });
                    };
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
                    request.onerror = (e) => reject(e);
                });
            }
            async saveBulk(dataArray) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    store.clear();
                    dataArray.forEach(item => store.put(item));
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e);
                });
            }
            async getAll() {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readonly');
                    const req = tx.objectStore(this.storeName).getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = (e) => reject(e);
                });
            }
        }
        const dbHelper = new MasterDB();

        // --- Translations ---
        const t = {
            title: { ko: "S.A.Y COIN Dashboard", en: "S.A.Y COIN Dashboard" },
            subtitle: { ko: "서버 저장 없는 실시간 로컬 분석", en: "Secure Client-side Analytics" },
            refresh: { ko: "데이터 갱신", en: "Refresh" },
            btn_upload: { ko: "마스터정보 입력", en: "Import Master Data" },
            btn_download: { ko: "Excel Download (Eng)", en: "Excel Download (Eng)" },
            loading: { ko: "데이터 불러오는 중...", en: "Loading..." },
            
            sect_month: { ko: "이번 달 현황", en: "This Month Status" },
            sect_total: { ko: "전체 누적 현황", en: "All Time Status" },

            card_issued_month: { ko: "이번 달 지급", en: "Issued (Month)" },
            card_used_month: { ko: "이번 달 사용", en: "Redeemed (Month)" },
            card_issued: { ko: "총 지급 코인", en: "Total Issued" },
            card_used: { ko: "총 사용(회수) 코인", en: "Total Redeemed" },
            card_remain: { ko: "시중 유통량", en: "Circulation" },
            card_rate: { ko: "코인 회수율", en: "Redemption Rate" },
            
            chart_general: { ko: "일반 지급 사유", en: "Issued by Reason (General)" },
            chart_hse: { ko: "HSE 지급 사유", en: "Issued by Reason (HSE)" },
            chart_holdings: { ko: "협력사별 코인 보유 비율", en: "Active Coin Holdings by Company" },
            chart_trend_worker: { ko: "협력사별 코인 지급 추세(근로자)", en: "Monthly Issuance by Company (Worker)" },
            chart_cumulative: { ko: "협력사별 지급 누적량 (Cumulative)", en: "Cumulative Issuance by Company" },
            
            table_title: { ko: "협력사 코인 지급 추세(업체)", en: "Company Coin Balance (Direct)" },
            th_name: { ko: "협력사명", en: "Company" },
            th_give: { ko: "총 지급 (Give)", en: "Given" },
            th_use: { ko: "총 사용 (Use)", en: "Used" },
            th_balance: { ko: "현재 잔액", en: "Balance" },

            modal_title: { ko: "마스터 정보 로컬 저장", en: "Save Master Data Locally" },
            modal_security: { ko: "데이터는 서버로 전송되지 않고 내 PC(IndexedDB)에만 저장됩니다.", en: "Data is stored locally on your PC (IndexedDB) only." },
            modal_desc: { ko: "엑셀의 [Passport, Company, Name, Designation] 4개 열을 복사해 붙여넣으세요.", en: "Paste [Passport, Company, Name, Designation] columns here." },
            btn_close: { ko: "닫기", en: "Close" },
            btn_save: { ko: "저장하기", en: "Save Locally" },
        };

        window.onload = async function() { 
            applyLanguage(); 
            await loadLocalMasterData();
            await fetchData(); 
        };

        function toggleLanguage() {
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            document.getElementById('langBtnText').innerText = currentLang === 'ko' ? 'EN' : 'KO';
            applyLanguage();
            if (cachedData) processAndRender(cachedData);
        }

        function setChartMode(mode) {
            chartMode = mode;
            // UI Toggle Style
            const btnAll = document.getElementById('btnAll');
            const btnMonth = document.getElementById('btnMonth');
            if(mode === 'all') {
                btnAll.className = "px-4 py-1 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition";
                btnMonth.className = "px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition";
            } else {
                btnAll.className = "px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition";
                btnMonth.className = "px-4 py-1 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition";
            }
            if (cachedData) processAndRender(cachedData);
        }

        function applyLanguage() {
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (t[key]) el.innerHTML = t[key][currentLang];
            });
        }

        function toggleModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }

        async function loadLocalMasterData() {
            try {
                const results = await dbHelper.getAll();
                localMasterMap = {};
                if (results && results.length > 0) {
                    results.forEach(item => { localMasterMap[item.passport] = { company: item.company, name: item.name, desig: item.desig }; });
                }
            } catch (e) { console.error("DB Error", e); }
        }

        async function saveToIndexedDB() {
            const rawText = document.getElementById('pasteArea').value.trim();
            if (!rawText) return alert("데이터를 입력하세요.");
            const rows = rawText.split('\n').map(line => line.split('\t').map(c => c.trim()));
            if (rows.length === 0 || rows[0].length < 4) return alert("최소 4개 열이 필요합니다.");
            
            const dataToSave = [];
            rows.forEach(r => { if(r[0]) dataToSave.push({ passport: r[0], company: r[1], name: r[2], desig: r[3] }); });

            if (!confirm(`${dataToSave.length}명의 데이터를 저장하시겠습니까?`)) return;
            try {
                await dbHelper.saveBulk(dataToSave);
                alert("저장 완료!");
                toggleModal();
                await loadLocalMasterData();
                if (cachedData) processAndRender(cachedData);
            } catch (e) { alert("저장 실패: " + e); }
        }

        async function fetchData() {
            if (GAS_URL.includes("YOUR_GAS")) return alert("GAS URL을 설정하세요.");
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            try {
                const res = await fetch(GAS_URL);
                const json = await res.json();
                if (json.status === 'success') {
                    cachedData = json.data;
                    processAndRender(cachedData);
                }
            } catch (e) { console.error(e); alert("데이터 로드 실패"); } 
            finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            }
        }

        // --- Core Logic ---
        function checkMasterDataHealth(logs) {
            let missingCount = 0;
            // Check for unique passports missing in master
            const uniquePassports = new Set(logs.map(r => r[3])); // D column
            uniquePassports.forEach(pp => {
                if (pp && !localMasterMap[pp]) missingCount++;
            });

            const banner = document.getElementById('statusBanner');
            banner.classList.remove('hidden', 'bg-green-50', 'border-green-500', 'bg-red-50', 'border-red-500', 'bg-yellow-50', 'border-yellow-400');
            
            if (Object.keys(localMasterMap).length === 0) {
                // No Master Data
                banner.classList.add('bg-yellow-50', 'border-yellow-400', 'border-l-4');
                banner.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-yellow-700 font-bold">${t.warn_title[currentLang]}</p>
                            <p class="text-xs text-yellow-600">${t.warn_desc[currentLang]}</p>
                        </div>
                    </div>`;
            } else if (missingCount > 0) {
                // Data Mismatch (Red)
                banner.classList.add('bg-red-50', 'border-red-500', 'border-l-4');
                banner.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-times-circle text-red-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-red-700 font-bold">마스터파일 정보 업데이트가 필요합니다.</p>
                            <p class="text-xs text-red-600">지급 내역에 있는 여권번호 중 ${missingCount}명의 정보를 마스터파일에서 찾을 수 없습니다. 최신 엑셀 파일로 업데이트 해주세요.</p>
                        </div>
                    </div>`;
            } else {
                // All Good (Green)
                banner.classList.add('bg-green-50', 'border-green-500', 'border-l-4');
                banner.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-green-700 font-bold">마스터파일 로드 완료</p>
                            <p class="text-xs text-green-600">${Object.keys(localMasterMap).length} entries loaded. All active passports matched.</p>
                        </div>
                    </div>`;
            }
        }

        function isThisMonth(dateStr) {
            const d = new Date(dateStr);
            const now = new Date();
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }

        function processAndRender(data) {
            const { logs, usage, subcon, categories } = data;
            
            // 1. Check Data Integrity
            checkMasterDataHealth(logs);

            // 2. KPI Calculations
            const totalIssued = logs.length;
            const totalUsed = usage.length;
            const remaining = totalIssued - totalUsed;
            const rate = totalIssued > 0 ? ((totalUsed / totalIssued) * 100).toFixed(1) + "%" : "0%";

            // This Month KPI
            const monthIssued = logs.filter(r => isThisMonth(r[0])).length;
            const monthUsed = usage.filter(r => isThisMonth(r[0])).length;

            document.getElementById('totalIssued').innerText = totalIssued.toLocaleString();
            document.getElementById('totalUsed').innerText = totalUsed.toLocaleString();
            document.getElementById('currentCirculation').innerText = remaining.toLocaleString();
            document.getElementById('returnRate').innerText = rate;
            
            document.getElementById('monthIssued').innerText = monthIssued.toLocaleString();
            document.getElementById('monthUsed').innerText = monthUsed.toLocaleString();


            // 3. Mapping & Aggregation
            const permMap = {};
            categories.forEach(row => { if (row[1]) permMap[row[1]] = row[5]; });

            const reasonGeneral = {}, reasonHSE = {}, companyTrend = {};
            const activeCoinsByComp = {}; // For Doughnut

            // Process Logs
            logs.forEach(row => {
                const ts = new Date(row[0]);
                const passport = row[3];
                // Column Selection for Reason based on Lang
                // KO: Bottom_KO(6), EN: Bottom_EN(8)
                const reasonColIdx = currentLang === 'ko' ? 6 : 8;
                const reason = row[reasonColIdx] || row[6]; // Fallback to KO
                const categoryKey = row[6]; // Use original key for permission check

                // Filter for Charts (Toggle)
                if (chartMode === 'all' || isThisMonth(row[0])) {
                    if (permMap[categoryKey] === 'Master') reasonHSE[reason] = (reasonHSE[reason] || 0) + 1;
                    else reasonGeneral[reason] = (reasonGeneral[reason] || 0) + 1;
                }

                let comp = 'Unregistered';
                if (localMasterMap[passport]) comp = localMasterMap[passport].company || 'Unknown';
                
                // Active Coin Calc (Issued +)
                activeCoinsByComp[comp] = (activeCoinsByComp[comp] || 0) + 1;

                const yyyymm = ts.toISOString().slice(0, 7);
                if (!companyTrend[comp]) companyTrend[comp] = {};
                companyTrend[comp][yyyymm] = (companyTrend[comp][yyyymm] || 0) + 1;
            });

            // Process Usage (Subtract from Active Coins)
            usage.forEach(row => {
                const passport = row[3];
                let comp = 'Unregistered';
                if (localMasterMap[passport]) comp = localMasterMap[passport].company || 'Unknown';
                
                // Active Coin Calc (Used -)
                if (activeCoinsByComp[comp]) {
                    activeCoinsByComp[comp] -= 1;
                }
            });

            // Calculate Cumulative Data
            const allMonths = new Set();
            Object.values(companyTrend).forEach(m => Object.keys(m).forEach(k => allMonths.add(k)));
            const sortedMonths = Array.from(allMonths).sort();
            
            const cumulativeTrend = {};
            Object.keys(companyTrend).forEach(comp => {
                cumulativeTrend[comp] = {};
                let sum = 0;
                sortedMonths.forEach(ym => {
                    const val = companyTrend[comp][ym] || 0;
                    sum += val;
                    cumulativeTrend[comp][ym] = sum;
                });
            });

            // Render Charts
            drawBarChart('chartGeneral', reasonGeneral, 'rgba(59, 130, 246, 0.7)');
            drawBarChart('chartHSE', reasonHSE, 'rgba(239, 68, 68, 0.7)');
            
            // New Holdings Chart (Donut)
            // Filter out 0 or negative balances for clearer chart
            const holdingsData = {};
            Object.keys(activeCoinsByComp).forEach(k => {
                if(activeCoinsByComp[k] > 0) holdingsData[k] = activeCoinsByComp[k];
            });
            drawDoughnutChart('chartHoldings', holdingsData);

            drawLineChart('chartTrend', companyTrend, false); 
            drawLineChart('chartCumulative', cumulativeTrend, true); 
            drawSubconTable(subcon);
        }

        // ===============================================
        // Excel Download
        // ===============================================
        function downloadExcel() {
            if (!cachedData) return alert("No Data");
            const { logs, subcon } = cachedData;
            const wb = XLSX.utils.book_new();

            // 1. Raw Data
            const rawSheetData = logs.map(row => {
                const passport = row[3];
                const info = localMasterMap[passport] || { company: "Unregistered", name: "Unregistered", desig: "-" };
                const date = new Date(row[0]);
                return {
                    "Timestamp": row[0],
                    "Month": `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`,
                    "Manager": row[2],
                    "Passport_No": passport,
                    "Name": info.name,
                    "Company": info.company,
                    "Designation": info.desig,
                    "Coin_No": row[4],
                    "Top_Category(KO)": row[5],
                    "Bottom_Category(KO)": row[6],
                    "Top_Category(EN)": row[7],
                    "Bottom_Category(EN)": row[8]
                };
            });
            const wsRaw = XLSX.utils.json_to_sheet(rawSheetData);
            XLSX.utils.book_append_sheet(wb, wsRaw, "Raw_Log_Data");

            // 2. Helper for Pivot
            const allMonths = new Set();
            rawSheetData.forEach(i => allMonths.add(i.Month));
            const sortedMonths = Array.from(allMonths).sort();

            // 3. Sheet: Monthly Worker Issuance
            const pivotWorker = {};
            rawSheetData.forEach(i => {
                if (!pivotWorker[i.Company]) pivotWorker[i.Company] = {};
                pivotWorker[i.Company][i.Month] = (pivotWorker[i.Company][i.Month] || 0) + 1;
            });
            const sheetWorker = Object.keys(pivotWorker).map(comp => {
                let row = { "Company": comp };
                let total = 0;
                sortedMonths.forEach(m => {
                    let val = pivotWorker[comp][m] || 0;
                    row[m] = val;
                    total += val;
                });
                row["Total"] = total;
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetWorker), "Worker_Monthly_Trend");

            // 4. Sheet: Reason Analysis (EN)
            const pivotReason = {};
            rawSheetData.forEach(i => {
                const reasonKey = i["Bottom_Category(EN)"] || i["Bottom_Category(KO)"]; 
                if (!pivotReason[reasonKey]) pivotReason[reasonKey] = {};
                pivotReason[reasonKey][i.Month] = (pivotReason[reasonKey][i.Month] || 0) + 1;
            });
            const sheetReason = Object.keys(pivotReason).map(r => {
                let row = { "Reason": r };
                let total = 0;
                sortedMonths.forEach(m => {
                    let val = pivotReason[r][m] || 0;
                    row[m] = val;
                    total += val;
                });
                row["Total"] = total;
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetReason), "Reason_Analysis");

            // 5. Sheet: Subcon Direct Status
            const subconStats = {};
            subcon.forEach(row => {
                const name = row[2], type = row[3], qty = Number(row[4]) || 0;
                if (!subconStats[name]) subconStats[name] = { give: 0, use: 0 };
                if (type === 'Give') subconStats[name].give += qty;
                else if (type === 'Use') subconStats[name].use += qty;
            });
            const sheetSubcon = Object.keys(subconStats).map(name => {
                const s = subconStats[name];
                return { "Company": name, "Total_Given": s.give, "Total_Used": s.use, "Current_Balance": s.give - s.use };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetSubcon), "Subcon_Direct_Status");

            // Export
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10);
            XLSX.writeFile(wb, `SAY_COIN_Analytics_${dateStr}.xlsx`);
        }

        // --- Chart Helpers ---
        function getTopKeys(obj, limit = 5) { return Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, limit); }
        
        function drawBarChart(id, data, color) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            const sorted = getTopKeys(data, 10);
            charts[id] = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(i => i[0]), datasets: [{ label: 'Count', data: sorted.map(i => i[1]), backgroundColor: color, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
        }

        function drawDoughnutChart(id, dataObj) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            
            // Sort by value
            const sorted = Object.entries(dataObj).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(i => i[0]);
            const values = sorted.map(i => i[1]);
            
            // Generate Colors
            const bgColors = labels.map((_, i) => `hsl(${(i * 360) / labels.length}, 70%, 60%)`);

            charts[id] = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: values, 
                        backgroundColor: bgColors,
                        hoverOffset: 4
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, padding: 10, font: { size: 10 } } }
                    }
                } 
            });
        }

        function drawLineChart(id, trendData, isCumulative) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            const allMonths = new Set(); Object.values(trendData).forEach(m => Object.keys(m).forEach(k => allMonths.add(k)));
            const labels = Array.from(allMonths).sort();
            const datasets = Object.keys(trendData).map((comp, idx) => {
                const hue = (idx * 137.5) % 360;
                return { 
                    label: comp, 
                    data: labels.map(m => trendData[comp][m] || 0), 
                    borderColor: `hsl(${hue}, 70%, 50%)`, 
                    backgroundColor: isCumulative ? `hsla(${hue}, 70%, 50%, 0.1)` : `hsl(${hue}, 70%, 50%)`,
                    fill: isCumulative, 
                    tension: 0.3, pointRadius: 3 
                };
            });
            charts[id] = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } } });
        }

        function drawSubconTable(subconData) {
            const subconStats = {}; 
            subconData.forEach(row => { const name = row[2], type = row[3], qty = Number(row[4]) || 0; if (!subconStats[name]) subconStats[name] = { give: 0, use: 0 }; if (type === 'Give') subconStats[name].give += qty; else if (type === 'Use') subconStats[name].use += qty; });
            const tbody = document.getElementById('subconTableBody'); tbody.innerHTML = '';
            Object.keys(subconStats).forEach(name => { const s = subconStats[name], balance = s.give - s.use; tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${name}</td><td class="px-6 py-4 text-right text-blue-600">+${s.give.toLocaleString()}</td><td class="px-6 py-4 text-right text-red-600">-${s.use.toLocaleString()}</td><td class="px-6 py-4 text-right font-bold">${balance.toLocaleString()}</td></tr>`; });
        }
    </script>
</body>
</html>
