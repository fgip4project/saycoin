<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.Y Coin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
      body { padding: 20px; background-color: #f8f9fa; font-family: 'Malgun Gothic', sans-serif; }
      .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .step-box { border-left: 5px solid #0d6efd; padding: 20px; background: white; margin-bottom: 20px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      #dashboard-area { display: none; margin-top: 30px; }
      .table-responsive { max-height: 500px; overflow-y: auto; font-size: 0.85rem; background: white; border: 1px solid #ddd; }
      th { position: sticky; top: 0; background: #eee !important; z-index: 1; vertical-align: middle; text-align: center; }
      td { vertical-align: middle; }
      .loading { display: none; margin-right: 5px; }
      h2 { color: #333; font-weight: bold; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="mb-4 text-center">ğŸ“Š S.A.Y Coin ë°ì´í„° ì²˜ë¦¬ ë° ëŒ€ì‹œë³´ë“œ</h2>

      <div class="row">
        <div class="col-md-12">
          <div class="step-box">
            <h4><span class="badge bg-primary">Step 1</span> ë§ˆìŠ¤í„° ë°ì´í„° ì…ë ¥</h4>
            <p class="text-muted">
              ë§ˆìŠ¤í„° íŒŒì¼(PKG#4 ALL)ì˜ ë‚´ìš©ì„ ì „ì²´ ë³µì‚¬(Ctrl+A)í•˜ì—¬ ì•„ë˜ ì¹¸ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”(Ctrl+V).<br>
              <small>* Passport no, Company, Name ë“±ì˜ í—¤ë”ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</small>
            </p>
            <textarea id="masterDataInput" class="form-control mb-3" rows="5" placeholder="ì—‘ì…€ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            
            <div class="d-grid gap-2">
              <button class="btn btn-primary btn-lg" onclick="processData()">
                <span class="spinner-border spinner-border-sm loading" id="loadingSpinner" role="status"></span>
                ë°ì´í„° ë¶„ì„ ë° ëŒ€ì‹œë³´ë“œ ìƒì„±
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="dashboard-area">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="m-0">ğŸ“ˆ ë¶„ì„ ê²°ê³¼</h3>
          <button class="btn btn-success" onclick="downloadExcel()">
            <i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>

        <div class="card">
          <div class="card-header p-0">
            <ul class="nav nav-tabs card-header-tabs m-0" id="myTab" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-bs-target="#tab-users" data-bs-toggle="tab">Users Summary</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-target="#tab-comp" data-bs-toggle="tab">Company Stats</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-target="#tab-cat" data-bs-toggle="tab">Category Stats</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-target="#tab-worker" data-bs-toggle="tab">Worker Status</button></li>
            </ul>
          </div>
          <div class="card-body p-0">
            <div class="tab-content">
              <div class="tab-pane fade show active" id="tab-users"><div class="table-responsive p-2" id="div-users"></div></div>
              <div class="tab-pane fade" id="tab-comp"><div class="table-responsive p-2" id="div-comp"></div></div>
              <div class="tab-pane fade" id="tab-cat"><div class="table-responsive p-2" id="div-cat"></div></div>
              <div class="tab-pane fade" id="tab-worker"><div class="table-responsive p-2" id="div-worker"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ============================================================
      // [ì„¤ì •] ì—¬ê¸°ì— ë³µì‚¬í•œ GAS ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
      // ============================================================
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzu7n9nWXVQyAEDLBRH2UNG18wDvv8UD120b5fOeTEkYSIcmiEPLigM9ezgLo2EsEcX/exec"; 
      
      // ì „ì—­ ë³€ìˆ˜
      let finalExcelData = {};

      async function processData() {
        const masterText = document.getElementById('masterDataInput').value;
        
        if (!masterText.trim()) { alert("ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”."); return; }
        
        document.getElementById('loadingSpinner').style.display = 'inline-block';

        // 1. ë§ˆìŠ¤í„° ë°ì´í„° íŒŒì‹±
        const masterRows = masterText.split('\n').map(row => row.split('\t'));
        const masterDict = parseMasterData(masterRows);
        if (!masterDict) {
          document.getElementById('loadingSpinner').style.display = 'none';
          return; 
        }

        // 2. GAS API í˜¸ì¶œ (IDëŠ” ì´ë¯¸ ì„œë²„ì— ìˆìŒ)
        try {
          const response = await fetch(GAS_API_URL);
          if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜ (ë°°í¬ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”)");
          
          const result = await response.json();

          if (result.success) {
            analyzeData(masterDict, result.data);
          } else {
            alert("ì„œë²„ ì˜¤ë¥˜: " + result.error);
          }
        } catch (err) {
          alert("ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n" + err.message);
          console.error(err);
        } finally {
          document.getElementById('loadingSpinner').style.display = 'none';
        }
      }

      // --- ë°ì´í„° íŒŒì‹± ë° ë¶„ì„ ë¡œì§ ---

      function parseMasterData(rows) {
        if (rows.length < 2) return null;
        const headers = rows[0].map(h => h.trim());
        
        // ìœ ì—°í•œ í—¤ë” ì°¾ê¸° (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë“±ì€ í•„ìš”ì‹œ ì¶”ê°€)
        const colP = headers.findIndex(h => h.includes("Passport") || h.includes("passport"));
        const colC = headers.findIndex(h => h === "Company");
        const colN = headers.findIndex(h => h === "Name");
        const colD = headers.findIndex(h => h === "Designation");
        const colI = headers.findIndex(h => h.includes("Iqama"));

        if (colP === -1) { alert("ë§ˆìŠ¤í„° ë°ì´í„°ì—ì„œ 'Passport no' ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return null; }

        const dict = new Map();
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (row.length <= colP) continue;
          const pNo = String(row[colP]).trim();
          if (pNo) {
            dict.set(pNo, [
              colC > -1 ? row[colC] : "", 
              colN > -1 ? row[colN] : "", 
              colD > -1 ? row[colD] : "", 
              colI > -1 ? row[colI] : ""
            ]);
          }
        }
        return dict;
      }

      function analyzeData(masterDict, coinData) {
        const arrCats = coinData.categories;
        const arrLogs = coinData.logs;
        const arrUsage = coinData.usage;
        const arrUsers = coinData.users;

        // ì¹´í…Œê³ ë¦¬ ìˆ˜ëŸ‰ ë§¤í•‘
        const dictCatQty = new Map();
        for (let i = 1; i < arrCats.length; i++) {
          const key = `${arrCats[i][0]}|${arrCats[i][1]}|${arrCats[i][2]}|${arrCats[i][3]}`;
          dictCatQty.set(key, Number(arrCats[i][4]));
        }

        const dictMgrStats = {}, dictCompStats = {}, dictCatStats = {};
        const dictWorkerStats = new Map();
        const monthSet = new Set();
        const logsDetail = [];

        // Logs ë¶„ì„
        for (let i = 1; i < arrLogs.length; i++) {
          const row = arrLogs[i];
          if (!row[0]) continue;
          
          let dateObj = new Date(row[0]);
          let monthKey = "Unknown";
          if (!isNaN(dateObj.getTime())) {
            let m = dateObj.getMonth() + 1;
            monthKey = dateObj.getFullYear() + "-" + (m < 10 ? '0' + m : m);
            monthSet.add(monthKey);
          }
          
          const mgrID = String(row[1]);
          const pNo = String(row[3]);
          const catKey = `${row[5]}|${row[6]}|${row[7]}|${row[8]}`;
          
          let qtyVal = dictCatQty.has(catKey) ? dictCatQty.get(catKey) : 1;
          if (qtyVal === 0) qtyVal = 1;
          const caseContrib = 1 / qtyVal;

          // ê·¼ë¡œì ì •ë³´ ë§¤í•‘
          let coName = "Unknown", wName = "", wDesig = "", wIqama = "";
          if (masterDict.has(pNo)) {
            const info = masterDict.get(pNo);
            coName = info[0] || "Unknown";
            wName = info[1]; wDesig = info[2]; wIqama = info[3];
          }
          logsDetail.push([...row, coName, wName, wDesig, wIqama]);

          updateStats(dictMgrStats, mgrID, monthKey, caseContrib, 1);
          updateStats(dictCatStats, catKey, monthKey, caseContrib, 1);
          updateStats(dictCompStats, coName, monthKey, caseContrib, 1);

          if (!dictWorkerStats.has(pNo)) {
            dictWorkerStats.set(pNo, { name: wName, company: coName, desig: wDesig, iqama: wIqama, qty: 0, used: 0 });
          }
          dictWorkerStats.get(pNo).qty += 1;
        }

        // Usage ë¶„ì„
        const usageReasonCount = {};
        for (let i = 1; i < arrUsage.length; i++) {
          const row = arrUsage[i];
          const pNo = String(row[3]);
          const reason = String(row[5]);
          usageReasonCount[reason] = (usageReasonCount[reason] || 0) + 1;
          
          if (dictWorkerStats.has(pNo)) {
            dictWorkerStats.get(pNo).used += 1;
          } else {
            let info = masterDict.has(pNo) ? masterDict.get(pNo) : ["","","",""];
            dictWorkerStats.set(pNo, { name: info[1], company: info[0], desig: info[2], iqama: info[3], qty: 0, used: 1 });
          }
        }

        const sortedMonths = Array.from(monthSet).sort();
        finalExcelData = { sortedMonths, mgrStats: dictMgrStats, catStats: dictCatStats, compStats: dictCompStats, workerStats: dictWorkerStats, logsDetail, usageReasons: usageReasonCount, originalUsers: arrUsers, originalCats: arrCats, originalLogs: arrLogs };
        renderDashboard();
      }

      function updateStats(mainDict, key, month, cases, coins) {
        if (!mainDict[key]) mainDict[key] = {};
        if (!mainDict[key][month]) mainDict[key][month] = { cases: 0, coins: 0 };
        mainDict[key][month].cases += cases;
        mainDict[key][month].coins += coins;
      }

      // --- í™”ë©´ ë Œë”ë§ ---
      function renderDashboard() {
        const d = finalExcelData;
        const months = d.sortedMonths;

        // 1. Users
        let htmlUsers = `<table class="table table-striped table-bordered table-sm"><thead><tr>`;
        for(let i=0; i<6 && i<d.originalUsers[0].length; i++) htmlUsers += `<th>${d.originalUsers[0][i]}</th>`;
        months.forEach(m => htmlUsers += `<th>${m}</th>`);
        htmlUsers += `</tr></thead><tbody>`;
        for(let i=1; i<d.originalUsers.length; i++) {
          let row = d.originalUsers[i];
          let mgrID = String(row[0]);
          htmlUsers += `<tr>`;
          for(let j=0; j<6 && j<row.length; j++) htmlUsers += `<td>${row[j]}</td>`;
          months.forEach(m => {
            let txt = "";
            if (d.mgrStats[mgrID] && d.mgrStats[mgrID][m]) txt = `${Math.round(d.mgrStats[mgrID][m].cases)}(${d.mgrStats[mgrID][m].coins})`;
            htmlUsers += `<td>${txt}</td>`;
          });
          htmlUsers += `</tr>`;
        }
        htmlUsers += `</tbody></table>`;
        document.getElementById('div-users').innerHTML = htmlUsers;

        // 2. Company
        let htmlComp = `<table class="table table-striped table-bordered table-sm"><thead><tr><th>Company</th><th>Total</th>`;
        months.forEach(m => htmlComp += `<th>${m}</th>`);
        htmlComp += `</tr></thead><tbody>`;
        Object.keys(d.compStats).sort().forEach(comp => {
          let totalCases = 0, totalCoins = 0;
          let rowHtml = "";
          months.forEach(m => {
            let txt = "";
            if (d.compStats[comp][m]) {
              let s = d.compStats[comp][m];
              txt = `${Math.round(s.cases)}(${s.coins})`;
              totalCases += s.cases; totalCoins += s.coins;
            }
            rowHtml += `<td>${txt}</td>`;
          });
          htmlComp += `<tr><td>${comp}</td><td>${Math.round(totalCases)}(${totalCoins})</td>${rowHtml}</tr>`;
        });
        htmlComp += `</tbody></table>`;
        document.getElementById('div-comp').innerHTML = htmlComp;

        // 3. Worker
        let htmlWorker = `<table class="table table-striped table-bordered table-sm"><thead><tr><th>Passport</th><th>Name</th><th>Company</th><th>Designation</th><th>Iqama</th><th>Qty</th><th>Used</th><th>Remain</th></tr></thead><tbody>`;
        d.workerStats.forEach((val, key) => {
           htmlWorker += `<tr><td>${key}</td><td>${val.name}</td><td>${val.company}</td><td>${val.desig}</td><td>${val.iqama}</td><td>${val.qty}</td><td>${val.used}</td><td>${val.qty - val.used}</td></tr>`;
        });
        htmlWorker += `</tbody></table>`;
        document.getElementById('div-worker').innerHTML = htmlWorker;
        
        // 4. Cat (Placeholder)
        document.getElementById('div-cat').innerHTML = "<p class='text-center mt-3'>ì¹´í…Œê³ ë¦¬ ìƒì„¸ í†µê³„ëŠ” ì—‘ì…€ íŒŒì¼ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>";
        
        document.getElementById('dashboard-area').style.display = 'block';
      }

      // --- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ---
      function downloadExcel() {
        if (!finalExcelData.sortedMonths) return;
        const d = finalExcelData;
        const wb = XLSX.utils.book_new();

        // 1. Users Summary
        let usersData = [];
        usersData.push([...d.originalUsers[0].slice(0,6), ...d.sortedMonths]);
        for(let i=1; i<d.originalUsers.length; i++) {
           let row = [...d.originalUsers[i].slice(0,6)];
           let mgrID = String(row[0]);
           d.sortedMonths.forEach(m => {
             row.push(d.mgrStats[mgrID] && d.mgrStats[mgrID][m] ? `${Math.round(d.mgrStats[mgrID][m].cases)}(${d.mgrStats[mgrID][m].coins})` : "");
           });
           usersData.push(row);
        }
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(usersData), "Users_Summary");

        // 2. Logs Detail
        let logHeader = [...(d.originalLogs[0] || []), "Company", "Name", "Designation", "Iqama No"];
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([logHeader, ...d.logsDetail]), "Logs_Detail");

        // 3. Worker Status
        let workerData = [["Passport_No", "Name", "Company", "Designation", "Iqama_No", "Quantity", "Used", "Remain"]];
        d.workerStats.forEach((val, key) => workerData.push([key, val.name, val.company, val.desig, val.iqama, val.qty, val.used, val.qty - val.used]));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(workerData), "Worker_Status");

        // 4. Usage Reason
        let reasonData = [["Reason", "Count"]];
        Object.keys(d.usageReasons).forEach(k => reasonData.push([k, d.usageReasons[k]]));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(reasonData), "Usage_Reason");

        // 5. Category Stats
        let catData = [];
        catData.push(["Cat1", "Cat2", "Cat3", "Cat4", "Total", ...d.sortedMonths]);
        for(let i=1; i<d.originalCats.length; i++) {
          let r = d.originalCats[i];
          let catKey = `${r[0]}|${r[1]}|${r[2]}|${r[3]}`;
          let row = [r[0], r[1], r[2], r[3]];
          let totalCases = 0, totalCoins = 0, monthVals = [];
          d.sortedMonths.forEach(m => {
            if (d.catStats[catKey] && d.catStats[catKey][m]) {
              let s = d.catStats[catKey][m];
              monthVals.push(`${Math.round(s.cases)}(${s.coins})`);
              totalCases += s.cases; totalCoins += s.coins;
            } else { monthVals.push(""); }
          });
          row.push(`${Math.round(totalCases)}(${totalCoins})`);
          catData.push(row.concat(monthVals));
        }
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(catData), "Category_Stats");

        // 6. Company Stats
        let compData = [["Company", "Total", ...d.sortedMonths]];
        Object.keys(d.compStats).sort().forEach(comp => {
          let row = [comp];
          let totalCases = 0, totalCoins = 0, monthVals = [];
          d.sortedMonths.forEach(m => {
             if (d.compStats[comp][m]) {
               let s = d.compStats[comp][m];
               monthVals.push(`${Math.round(s.cases)}(${s.coins})`);
               totalCases += s.cases; totalCoins += s.coins;
             } else { monthVals.push(""); }
          });
          row.push(`${Math.round(totalCases)}(${totalCoins})`);
          compData.push(row.concat(monthVals));
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(compData), "Company_Stats");

        // íŒŒì¼ ì €ì¥
        let today = new Date();
        let fName = "S.A.Y_Coin_Data_" + today.getFullYear().toString().substr(2,2) + 
                    (today.getMonth()+1 < 10 ? '0' : '') + (today.getMonth()+1) + 
                    (today.getDate() < 10 ? '0' : '') + today.getDate() + ".xlsx";
        XLSX.writeFile(wb, fName);
      }
    </script>
  </body>
</html>
