<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì „ ì½”ì¸ ì›”ë³„ í†µí•© ë¶„ì„ ì‹œìŠ¤í…œ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Pretendard', 'Noto Sans KR', sans-serif; }
        .card-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stat-title { font-size: 0.9rem; color: #6c757d; margin-bottom: 5px; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: #2c3e50; }
        .stat-sub { font-size: 0.85rem; color: #28a745; }
        .input-area { width: 100%; height: 150px; border: 1px solid #ced4da; border-radius: 5px; padding: 10px; font-size: 12px; font-family: monospace; }
        th { cursor: pointer; background-color: #f8f9fa; user-select: none; }
        th:hover { background-color: #e9ecef; }
        .loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading" class="loading-mask">
        <div class="spinner-border text-primary" role="status"></div>
        <h5 class="mt-3">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h5>
        <p class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <nav class="navbar navbar-dark bg-primary shadow-sm mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fw-bold">ğŸ“Š ì•ˆì „ ì½”ì¸ ì›”ë³„ í†µí•© ë¶„ì„ê¸°</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        
        <div class="row">
            <div class="col-12">
                <div class="card-box">
                    <h5>ğŸ› ï¸ ë§ˆìŠ¤í„° íŒŒì¼ ë°ì´í„° ì…ë ¥</h5>
                    <p class="text-muted small">í—¤ë” ìˆœì„œ: <strong>Passport no | Company | Name | Designation | Iqama No</strong> (ë°ì´í„°ë§Œ ë¶™ì—¬ë„£ì–´ë„ ë©ë‹ˆë‹¤)</p>
                    <textarea id="pasteArea" class="input-area" placeholder="ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                    <div class="text-end mt-3">
                        <button class="btn btn-outline-secondary me-2" onclick="location.reload()">ğŸ”„ ì´ˆê¸°í™”</button>
                        <button class="btn btn-primary px-4 fw-bold" onclick="processData()">ğŸš€ ë°ì´í„° ë¶„ì„ ì‹œì‘</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" style="display:none;">
            
            <div class="row mb-2">
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">ì´ ì§€ê¸‰ ì½”ì¸ (ê°€ì¹˜)</div>
                        <div class="stat-val" id="disp_totalValue">0</div>
                        <div class="stat-sub" id="disp_monthValue">ì´ë²ˆ ë‹¬: 0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">ì´ ì§€ê¸‰ ê±´ìˆ˜</div>
                        <div class="stat-val" id="disp_totalLogs">0</div>
                        <div class="stat-sub" id="disp_monthLogs">ì´ë²ˆ ë‹¬: 0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">ì½”ì¸ íšŒìˆ˜ìœ¨ (ì „ì²´)</div>
                        <div class="stat-val text-warning" id="disp_usageRate">0%</div>
                        <div class="stat-sub" id="disp_usedCount">ì‚¬ìš©ë¨: 0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">ì§€ê¸‰ ëŒ€ìƒì (ì´ë ¥ ë³´ìœ )</div>
                        <div class="stat-val text-info" id="disp_activeWorkers">0</div>
                        <div class="stat-sub">ì „ì²´ ë§ˆìŠ¤í„° DB: <span id="disp_totalWorkers">0</span>ëª…</div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-8">
                    <div class="card-box" style="height: 400px;">
                        <h6>ğŸ“… ì›”ë³„ ì½”ì¸ ì§€ê¸‰ ì¶”ì´ (ì „ì²´)</h6>
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-box" style="height: 400px;">
                        <h6>ğŸ¢ íšŒì‚¬ë³„ ì ìœ ìœ¨ (ìƒìœ„ 5)</h6>
                        <canvas id="companyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card-box">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">ğŸ“‹ ê·¼ë¡œìë³„ ìƒì„¸ ë¶„ì„ (ìƒìœ„ 100ëª… ë¯¸ë¦¬ë³´ê¸°)</h5>
                            <div>
                                <select id="sortSelect" class="form-select d-inline-block w-auto me-2" onchange="renderTable()">
                                    <option value="Total_Value">ì½”ì¸ ê°€ì¹˜ ë†’ì€ìˆœ</option>
                                    <option value="Log_Count">ì§€ê¸‰ ê±´ìˆ˜ ë§ì€ìˆœ</option>
                                    <option value="Used_Value">ì‚¬ìš© ê°€ì¹˜ ë†’ì€ìˆœ</option>
                                    <option value="Remaining_Value">ì”ì•¡ ë§ì€ìˆœ</option>
                                </select>
                                <button class="btn btn-success fw-bold" onclick="downloadFullExcel()">
                                    ğŸ“¥ ì—‘ì…€ ì „ì²´ ë‹¤ìš´ë¡œë“œ (ìƒì„¸í¬í•¨)
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
                            <table class="table table-hover table-striped align-middle">
                                <thead class="table-light sticky-top" style="z-index: 1;">
                                    <tr>
                                        <th>Passport No</th>
                                        <th>Company</th>
                                        <th>Name</th>
                                        <th>ì§€ê¸‰ ê±´ìˆ˜</th>
                                        <th>ì´ íšë“ ì½”ì¸</th>
                                        <th>ì‚¬ìš© ì½”ì¸</th>
                                        <th>ì”ì—¬ ì½”ì¸</th>
                                    </tr>
                                </thead>
                                <tbody id="workerTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div> </div>

    <script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— ë°°í¬ëœ GAS URLì„ ê¼­ ë„£ì–´ì£¼ì„¸ìš” â–¼â–¼â–¼
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzFlddxuZi3MU_Vf9-0GL2nNsYQepD-x8FEiFNXC6mPNjAYFZU2UpSb3mTBP9grcnd3/exec"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // ì „ì—­ ë³€ìˆ˜
        let RAW_DATA = {}; // GAS ì›ë³¸
        let ANALYZED_DATA = {
            workers: [], // ê·¼ë¡œìë³„ í†µê³„ (ë°°ì—´)
            companies: {}, // íšŒì‚¬ë³„ í†µê³„
            managers: {}, // ê´€ë¦¬ìë³„ í†µê³„
            reasons: {}, // ì‚¬ìœ ë³„ í†µê³„
            usageReasons: {}, // ì‚¬ìš© ì‚¬ìœ ë³„ í†µê³„
            monthlyLabels: [], // ì¡´ì¬í•˜ëŠ” ëª¨ë“  "YYYY-MM" ë¦¬ìŠ¤íŠ¸
            monthlyTrend: {} // ì›”ë³„ ì „ì²´ ì¶”ì„¸
        };
        let CURRENT_MONTH_KEY = "";

        // 1. ì´ˆê¸°í™” ë° ë‚ ì§œ í‚¤ ìƒì„± í•¨ìˆ˜
        function init() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            CURRENT_MONTH_KEY = `${y}-${m}`;
        }

        // ë‚ ì§œ íŒŒì‹± í—¬í¼ (ISO string or Excel serial -> YYYY-MM)
        function getMonthKey(dateInput) {
            if (!dateInput) return "Unknown";
            let dateObj;
            if (typeof dateInput === 'number') {
                // ì—‘ì…€ ë‚ ì§œ ì‹œë¦¬ì–¼ (1900ë…„ ê¸°ì¤€) ë‹¨ìˆœ ë³€í™˜
                dateObj = new Date(Math.round((dateInput - 25569)*86400*1000));
            } else {
                dateObj = new Date(dateInput);
            }
            if (isNaN(dateObj)) return "Unknown";
            
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            return `${y}-${m}`;
        }

        // 2. ë©”ì¸ í”„ë¡œì„¸ìŠ¤
        async function processData() {
            init();
            const inputVal = document.getElementById('pasteArea').value;
            if (!inputVal.trim()) { alert("ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”."); return; }

            document.getElementById('loading').style.display = 'flex';

            try {
                // A. ë§ˆìŠ¤í„° íŒŒì¼ íŒŒì‹±
                const parsed = Papa.parse(inputVal, { delimiter: "\t", header: false });
                const masterRows = parsed.data;

                // B. GAS ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(GAS_URL);
                RAW_DATA = await response.json();

                // C. ë°ì´í„° ë¶„ì„ ì‹¤í–‰
                performAnalysis(masterRows);

                // D. í™”ë©´ ë Œë”ë§
                renderDashboard();

            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // 3. ì •ë°€ ë¶„ì„ ë¡œì§
        function performAnalysis(masterRows) {
            // [ì´ˆê¸°í™”]
            const workers = {}; // Key: Passport
            const companies = {}; // Key: Company Name
            const managers = {}; // Key: Manager ID
            const reasons = {}; // Key: Reason Full Name
            const usageReasons = {}; // Key: Usage Reason
            const monthlySet = new Set();
            const monthlyTrend = {};

            // 3-1. ì¹´í…Œê³ ë¦¬ ë§µí•‘ (ì½”ì¸ ê°€ì¹˜ lookup)
            const catMap = {};
            RAW_DATA.categories.slice(1).forEach(row => {
                // Key: Top_KO|Bottom_KO|Top_EN|Bottom_EN
                const key = `${row[0]}|${row[1]}|${row[2]}|${row[3]}`;
                catMap[key] = Number(row[4]) || 0;
            });

            // 3-2. ê´€ë¦¬ì ì´ë¦„ ë§µí•‘
            const managerNameMap = {};
            RAW_DATA.users.slice(1).forEach(row => {
                managerNameMap[row[0]] = row[2]; // ID -> Name
            });

            // 3-3. Logs ë°ì´í„° ìˆœíšŒ (í•µì‹¬)
            // Header: Timestamp(0), Manager_ID(1), Manager_Name(2), Passport_No(3), Coin_No(4), Reason(5~8)...
            RAW_DATA.logs.slice(1).forEach(row => {
                const ts = row[0];
                const mId = row[1];
                const ppt = String(row[3]).trim();
                const coinNo = String(row[4]);
                const reasonKey = `${row[5]}|${row[6]}|${row[7]}|${row[8]}`;
                const reasonName = `${row[5]} > ${row[6]}`;
                
                const value = catMap[reasonKey] || 0;
                const month = getMonthKey(ts);
                const isUsed = coinNo.includes('*');

                monthlySet.add(month);

                // A. ê·¼ë¡œìë³„ ì§‘ê³„ (ì„ì‹œ ì €ì¥)
                if (!workers[ppt]) workers[ppt] = { 
                    logs: 0, value: 0, usedVal: 0, 
                    monthly: {}, // { '2023-10': { val: 0, logs: 0 } }
                    exists: true 
                };
                
                let w = workers[ppt];
                w.logs++;
                w.value += value;
                if (isUsed) w.usedVal += value; // ì‚¬ìš©ëœ ì½”ì¸ì˜ 'ê°€ì¹˜' ëˆ„ì 

                if (!w.monthly[month]) w.monthly[month] = { val: 0, logs: 0 };
                w.monthly[month].val += value;
                w.monthly[month].logs++;

                // B. ê´€ë¦¬ìë³„ ì§‘ê³„
                if (!managers[mId]) managers[mId] = { 
                    name: managerNameMap[mId] || row[2], 
                    totalLogs: 0, totalVal: 0, monthly: {} 
                };
                managers[mId].totalLogs++;
                managers[mId].totalVal += value;
                if (!managers[mId].monthly[month]) managers[mId].monthly[month] = { val: 0, logs: 0 };
                managers[mId].monthly[month].val += value;
                managers[mId].monthly[month].logs++;

                // C. ì§€ê¸‰ ì‚¬ìœ ë³„ ì§‘ê³„
                if (!reasons[reasonName]) reasons[reasonName] = 0;
                reasons[reasonName]++;

                // D. ì›”ë³„ ì „ì²´ íŠ¸ë Œë“œ
                if (!monthlyTrend[month]) monthlyTrend[month] = 0;
                monthlyTrend[month] += value;
            });

            // 3-4. Usage ë°ì´í„° ìˆœíšŒ (ì‚¬ìš© ì‚¬ìœ  ë¶„ì„)
            // Header: Timestamp, Manager, Name, Passport, Coin, Reason
            RAW_DATA.usage.slice(1).forEach(row => {
                const month = getMonthKey(row[0]);
                const reason = row[5] || "Unspecified";
                
                if (!usageReasons[reason]) usageReasons[reason] = { total: 0, monthly: {} };
                usageReasons[reason].total++;
                if (!usageReasons[reason].monthly[month]) usageReasons[reason].monthly[month] = 0;
                usageReasons[reason].monthly[month]++;
            });

            // 3-5. Master ë°ì´í„°ì™€ ê·¼ë¡œì ë°ì´í„° ë³‘í•©
            ANALYZED_DATA.workers = [];
            
            masterRows.forEach(row => {
                // í—¤ë” ìŠ¤í‚µ ë¡œì§ (Passport ë‹¨ì–´ í¬í•¨ ì‹œ)
                const ppt = String(row[0]).trim();
                if (!ppt || ppt.toLowerCase().includes('passport')) return;

                const comp = row[1];
                const info = workers[ppt]; // Logsì— ê¸°ë¡ì´ ìˆëŠ”ê°€?

                if (info) {
                    // ê¸°ë¡ ìˆëŠ” ì‚¬ëŒë§Œ ì¶”ê°€
                    ANALYZED_DATA.workers.push({
                        Passport: ppt,
                        Company: comp,
                        Name: row[2],
                        Designation: row[3],
                        Total_Logs: info.logs,
                        Total_Value: info.value,
                        Used_Value: info.usedVal,
                        Remaining_Value: info.value - info.usedVal,
                        Monthly_Data: info.monthly
                    });

                    // íšŒì‚¬ë³„ ì§‘ê³„ (ê¸°ë¡ ìˆëŠ” ì‚¬ëŒ ê¸°ì¤€)
                    if (!companies[comp]) companies[comp] = { totalVal: 0, monthly: {} };
                    companies[comp].totalVal += info.value;
                    
                    // ì›”ë³„ í•©ì‚°
                    Object.keys(info.monthly).forEach(m => {
                        if (!companies[comp].monthly[m]) companies[comp].monthly[m] = 0;
                        companies[comp].monthly[m] += info.monthly[m].val;
                    });
                }
            });

            // ë°ì´í„° ì •ë¦¬
            ANALYZED_DATA.companies = companies;
            ANALYZED_DATA.managers = managers;
            ANALYZED_DATA.reasons = reasons;
            ANALYZED_DATA.usageReasons = usageReasons;
            ANALYZED_DATA.monthlyLabels = Array.from(monthlySet).sort();
            ANALYZED_DATA.monthlyTrend = monthlyTrend;
        }

        // 4. ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        function renderDashboard() {
            document.getElementById('dashboard').style.display = 'block';
            
            const workers = ANALYZED_DATA.workers;
            const totalVal = workers.reduce((sum, w) => sum + w.Total_Value, 0);
            const totalLogs = workers.reduce((sum, w) => sum + w.Total_Logs, 0);
            const totalUsed = workers.reduce((sum, w) => sum + w.Used_Value, 0);

            // ì´ë²ˆ ë‹¬ ë°ì´í„° ê³„ì‚°
            let monthVal = 0;
            let monthLogs = 0;
            workers.forEach(w => {
                if (w.Monthly_Data[CURRENT_MONTH_KEY]) {
                    monthVal += w.Monthly_Data[CURRENT_MONTH_KEY].val;
                    monthLogs += w.Monthly_Data[CURRENT_MONTH_KEY].logs;
                }
            });

            // A. ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('disp_totalValue').innerText = totalVal.toLocaleString();
            document.getElementById('disp_monthValue').innerText = `ì´ë²ˆ ë‹¬: ${monthVal.toLocaleString()}`;
            document.getElementById('disp_totalLogs').innerText = totalLogs.toLocaleString();
            document.getElementById('disp_monthLogs').innerText = `ì´ë²ˆ ë‹¬: ${monthLogs.toLocaleString()}`;
            document.getElementById('disp_usageRate').innerText = totalVal ? ((totalUsed / totalVal)*100).toFixed(1) + "%" : "0%";
            document.getElementById('disp_usedCount').innerText = `ì‚¬ìš©ë¨(ê°€ì¹˜): ${totalUsed.toLocaleString()}`;
            document.getElementById('disp_activeWorkers').innerText = workers.length.toLocaleString();
            
            // B. ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            renderCharts();

            // C. í…Œì´ë¸” ê·¸ë¦¬ê¸°
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('workerTableBody');
            tbody.innerHTML = "";
            const sortBy = document.getElementById('sortSelect').value;
            
            // ì •ë ¬ í›„ ìƒìœ„ 100ëª…
            const sorted = [...ANALYZED_DATA.workers].sort((a, b) => b[sortBy] - a[sortBy]).slice(0, 100);

            sorted.forEach(w => {
                tbody.innerHTML += `
                    <tr>
                        <td>${w.Passport}</td>
                        <td>${w.Company}</td>
                        <td>${w.Name}</td>
                        <td>${w.Total_Logs}</td>
                        <td class="fw-bold text-primary">${w.Total_Value}</td>
                        <td class="text-danger">${w.Used_Value}</td>
                        <td class="fw-bold">${w.Remaining_Value}</td>
                    </tr>
                `;
            });
        }

        function renderCharts() {
            // ì¶”ì„¸ ì°¨íŠ¸
            const labels = ANALYZED_DATA.monthlyLabels;
            const trendData = labels.map(m => ANALYZED_DATA.monthlyTrend[m] || 0);
            
            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì›”ë³„ ì´ ì§€ê¸‰ ê°€ì¹˜',
                        data: trendData,
                        borderColor: '#0d6efd',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(13, 110, 253, 0.1)'
                    }]
                }
            });

            // íšŒì‚¬ë³„ ì°¨íŠ¸
            const compEntries = Object.entries(ANALYZED_DATA.companies)
                .sort((a, b) => b[1].totalVal - a[1].totalVal)
                .slice(0, 5);
            
            new Chart(document.getElementById('companyChart'), {
                type: 'doughnut',
                data: {
                    labels: compEntries.map(x => x[0]),
                    datasets: [{
                        data: compEntries.map(x => x[1].totalVal),
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                    }]
                }
            });
        }

        // 5. ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë©€í‹° ì‹œíŠ¸ & í”¼ë²—)
        function downloadFullExcel() {
            if (ANALYZED_DATA.workers.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            const wb = XLSX.utils.book_new();
            const months = ANALYZED_DATA.monthlyLabels;

            // [ì‹œíŠ¸ 1] ê·¼ë¡œì ìƒì„¸ (ì›”ë³„ í¬í•¨)
            const workerSheetData = ANALYZED_DATA.workers.map(w => {
                const row = {
                    "Passport": w.Passport,
                    "Company": w.Company,
                    "Name": w.Name,
                    "Designation": w.Designation,
                    "ì´ ì§€ê¸‰ ê±´ìˆ˜": w.Total_Logs,
                    "ì´ ì½”ì¸ ê°€ì¹˜": w.Total_Value,
                    "ì‚¬ìš© ì½”ì¸ ê°€ì¹˜": w.Used_Value,
                    "ì”ì—¬ ì½”ì¸ ê°€ì¹˜": w.Remaining_Value
                };
                // ì›”ë³„ ì»¬ëŸ¼ ì¶”ê°€
                months.forEach(m => {
                    row[`${m} (íšë“)`] = w.Monthly_Data[m] ? w.Monthly_Data[m].val : 0;
                });
                return row;
            });
            const ws1 = XLSX.utils.json_to_sheet(workerSheetData);
            XLSX.utils.book_append_sheet(wb, ws1, "ê·¼ë¡œì_ì›”ë³„ìƒì„¸");

            // [ì‹œíŠ¸ 2] ì—…ì²´ë³„ í†µê³„ (ì›”ë³„ í¬í•¨)
            const companySheetData = Object.keys(ANALYZED_DATA.companies).map(cName => {
                const cInfo = ANALYZED_DATA.companies[cName];
                const row = { "Company": cName, "Total Value": cInfo.totalVal };
                months.forEach(m => {
                    row[`${m}`] = cInfo.monthly[m] || 0;
                });
                return row;
            });
            const ws2 = XLSX.utils.json_to_sheet(companySheetData);
            XLSX.utils.book_append_sheet(wb, ws2, "ì—…ì²´ë³„_í†µê³„");

            // [ì‹œíŠ¸ 3] ê´€ë¦¬ì ì‹¤ì  (ì›”ë³„ í¬í•¨)
            const managerSheetData = Object.keys(ANALYZED_DATA.managers).map(mid => {
                const mInfo = ANALYZED_DATA.managers[mid];
                const row = { "ID": mid, "Name": mInfo.name, "Total Logs": mInfo.totalLogs, "Total Value": mInfo.totalVal };
                months.forEach(m => {
                    row[`${m} (Qty)`] = mInfo.monthly[m] ? mInfo.monthly[m].val : 0;
                });
                return row;
            });
            const ws3 = XLSX.utils.json_to_sheet(managerSheetData);
            XLSX.utils.book_append_sheet(wb, ws3, "ê´€ë¦¬ì_ì‹¤ì ");

            // [ì‹œíŠ¸ 4] ì§€ê¸‰ ì‚¬ìœ  í†µê³„ (ì „ì²´)
            const reasonSheetData = Object.keys(ANALYZED_DATA.reasons).map(r => ({
                "ì§€ê¸‰ ì‚¬ìœ ": r, "ê±´ìˆ˜": ANALYZED_DATA.reasons[r]
            }));
            const ws4 = XLSX.utils.json_to_sheet(reasonSheetData);
            XLSX.utils.book_append_sheet(wb, ws4, "ì§€ê¸‰ì‚¬ìœ _ë¹ˆë„");

            // [ì‹œíŠ¸ 5] ì‚¬ìš© ë‚´ì—­ í†µê³„ (ì‚¬ìš©ì‚¬ìœ  & ì›”ë³„)
            const usageSheetData = Object.keys(ANALYZED_DATA.usageReasons).map(u => {
                const uInfo = ANALYZED_DATA.usageReasons[u];
                const row = { "ì‚¬ìš© ì‚¬ìœ ": u, "Total Count": uInfo.total };
                months.forEach(m => {
                    row[`${m}`] = uInfo.monthly[m] || 0;
                });
                return row;
            });
            const ws5 = XLSX.utils.json_to_sheet(usageSheetData);
            XLSX.utils.book_append_sheet(wb, ws5, "ì‚¬ìš©ì‚¬ìœ _í†µê³„");

            // íŒŒì¼ ì €ì¥
            XLSX.writeFile(wb, `ì•ˆì „ì½”ì¸_í†µí•©ë¶„ì„_${CURRENT_MONTH_KEY}.xlsx`);
        }
    </script>
</body>
</html>
