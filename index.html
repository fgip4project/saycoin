<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.Y COIN Data Manager</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .card-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stat-title { font-size: 0.9rem; color: #6c757d; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: #2c3e50; }
        .stat-sub { font-size: 0.85rem; color: #28a745; }
        .input-area { width: 100%; height: 150px; border: 1px solid #ced4da; border-radius: 5px; padding: 10px; font-size: 12px; font-family: monospace; }
        th { cursor: pointer; background-color: #f8f9fa; user-select: none; }
        th:hover { background-color: #e9ecef; }
        .loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading" class="loading-mask">
        <div class="spinner-border text-success" role="status"></div>
        <h5 class="mt-3">Processing Data...</h5>
        <p class="text-muted">Calculating Coin Qty & Cases (1/N)</p>
    </div>

    <nav class="navbar navbar-dark bg-success shadow-sm mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fw-bold">S.A.Y COIN Data Manager</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        
        <div class="row">
            <div class="col-12">
                <div class="card-box">
                    <h5>üõ†Ô∏è Master File Input</h5>
                    <p class="text-muted small">Required Header Order: <strong>Passport no | Company | Name | Designation | Iqama No</strong></p>
                    <textarea id="pasteArea" class="input-area" placeholder="Paste Excel data here (Ctrl+V)..."></textarea>
                    <div class="text-end mt-3">
                        <button class="btn btn-outline-secondary me-2" onclick="location.reload()">üîÑ Reset</button>
                        <button class="btn btn-success px-4 fw-bold" onclick="processData()">üöÄ Analyze</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" style="display:none;">
            
            <div class="row mb-2">
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">Total Distributed Coins</div>
                        <div class="stat-val" id="disp_totalQty">0</div>
                        <div class="stat-sub" id="disp_monthQty">This Month: 0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">Total Cases (Calc)</div>
                        <div class="stat-val" id="disp_totalCases">0</div>
                        <div class="stat-sub" id="disp_monthCases">This Month: 0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">Redemption Rate (Qty)</div>
                        <div class="stat-val text-warning" id="disp_usageRate">0%</div>
                        <div class="stat-sub" id="disp_usedCount">Redeemed: 0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-box text-center">
                        <div class="stat-title">Active Workers</div>
                        <div class="stat-val text-info" id="disp_activeWorkers">0</div>
                        <div class="stat-sub">Total Master DB: <span id="disp_totalWorkers">0</span></div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-8">
                    <div class="card-box" style="height: 400px;">
                        <h6>üìÖ Monthly Distribution Trend (Qty Base)</h6>
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-box" style="height: 400px;">
                        <h6>üè¢ Share by Company (Top 5)</h6>
                        <canvas id="companyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card-box">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">üìã Worker Details (Top 100 Preview)</h5>
                            <div>
                                <select id="sortSelect" class="form-select d-inline-block w-auto me-2" onchange="renderTable()">
                                    <option value="Total_Qty">Sort by Total Coins</option>
                                    <option value="Total_Cases">Sort by Total Cases</option>
                                    <option value="Remaining_Qty">Sort by Remaining</option>
                                </select>
                                <button class="btn btn-success fw-bold" onclick="downloadFullExcel()">
                                    üì• Download Full Excel
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
                            <table class="table table-hover table-striped align-middle">
                                <thead class="table-light sticky-top" style="z-index: 1;">
                                    <tr>
                                        <th>Passport No</th>
                                        <th>Company</th>
                                        <th>Name</th>
                                        <th>Cases (Calc)</th>
                                        <th>Total Coins</th>
                                        <th>Redeemed</th>
                                        <th>Remaining</th>
                                    </tr>
                                </thead>
                                <tbody id="workerTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ‚ñº‚ñº‚ñº INPUT YOUR GAS URL HERE ‚ñº‚ñº‚ñº
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzFlddxuZi3MU_Vf9-0GL2nNsYQepD-x8FEiFNXC6mPNjAYFZU2UpSb3mTBP9grcnd3/exec"; 
        // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

        // Global Variables
        let RAW_DATA = {}; 
        let ANALYZED_DATA = {
            workers: [], 
            companies: {}, 
            managers: {}, 
            reasons: {}, 
            usageReasons: {}, 
            monthlyLabels: [], 
            monthlyTrend: {} 
        };
        let CURRENT_MONTH_KEY = "";

        function init() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            CURRENT_MONTH_KEY = `${y}-${m}`;
        }

        function safeTrim(val) {
            if (val === undefined || val === null) return "";
            return String(val).trim();
        }

        function getMonthKey(dateInput) {
            if (!dateInput) return "Unknown";
            let dateObj;
            if (typeof dateInput === 'number') {
                dateObj = new Date(Math.round((dateInput - 25569)*86400*1000));
            } else {
                dateObj = new Date(dateInput);
            }
            if (isNaN(dateObj)) return "Unknown";
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            return `${y}-${m}`;
        }

        async function processData() {
            init();
            const inputVal = document.getElementById('pasteArea').value;
            if (!inputVal.trim()) { alert("Please paste data first."); return; }

            document.getElementById('loading').style.display = 'flex';

            try {
                const parsed = Papa.parse(inputVal, { delimiter: "\t", header: false });
                const masterRows = parsed.data;

                const response = await fetch(GAS_URL);
                RAW_DATA = await response.json();

                performAnalysis(masterRows);
                renderDashboard();

            } catch (e) {
                console.error(e);
                alert("An error occurred: " + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ‚ñº‚ñº‚ñº ANALYSIS LOGIC ‚ñº‚ñº‚ñº
        function performAnalysis(masterRows) {
            const workers = {}; 
            const companies = {}; 
            const managers = {}; 
            const reasons = {}; 
            const usageReasons = {}; 
            const monthlySet = new Set();
            const monthlyTrend = {};

            // 1. Map Categories (Get Base Quantity)
            const catMap = {};
            RAW_DATA.categories.slice(1).forEach(row => {
                if(!row[0]) return;
                // Key: 4 text fields combined
                const key = `${safeTrim(row[0])}|${safeTrim(row[1])}|${safeTrim(row[2])}|${safeTrim(row[3])}`;
                catMap[key] = Number(row[4]) || 1; // Default to 1 to avoid division by zero
            });

            // 2. Map Managers
            const managerNameMap = {};
            RAW_DATA.users.slice(1).forEach(row => {
                managerNameMap[safeTrim(row[0])] = row[2];
            });

            // 3. Process Logs (1 Row = 1 Coin)
            RAW_DATA.logs.slice(1).forEach(row => {
                if(!row[3]) return;

                const ts = row[0];
                const mId = safeTrim(row[1]);
                const ppt = safeTrim(row[3]); 
                const coinNo = String(row[4]);
                
                // Reason Keys
                const r1 = safeTrim(row[5]);
                const r2 = safeTrim(row[6]);
                const r3 = safeTrim(row[7]);
                const r4 = safeTrim(row[8]);
                const reasonKey = `${r1}|${r2}|${r3}|${r4}`;
                
                // Get Base Quantity for this reason
                const baseQty = catMap[reasonKey] || 1; 
                
                // ‚òÖ Calculation: Case = 1 / BaseQty
                const calculatedCase = (baseQty > 0) ? (1 / baseQty) : 0; 
                
                const month = getMonthKey(ts);
                const isUsed = coinNo.includes('*');

                monthlySet.add(month);

                // A. Worker Stats
                if (!workers[ppt]) workers[ppt] = { 
                    cases: 0.0, qty: 0, usedQty: 0, 
                    monthly: {}, exists: true 
                };
                
                let w = workers[ppt];
                w.qty += 1;             // 1 Row = 1 Coin
                w.cases += calculatedCase; 
                
                if (isUsed) w.usedQty += 1;

                if (!w.monthly[month]) w.monthly[month] = { qty: 0, cases: 0.0 };
                w.monthly[month].qty += 1;
                w.monthly[month].cases += calculatedCase;

                // B. Manager Stats
                if (!managers[mId]) managers[mId] = { 
                    name: managerNameMap[mId] || row[2], 
                    totalCases: 0.0, totalQty: 0, monthly: {} 
                };
                managers[mId].totalQty += 1;
                managers[mId].totalCases += calculatedCase;
                
                if (!managers[mId].monthly[month]) managers[mId].monthly[month] = { qty: 0, cases: 0.0 };
                managers[mId].monthly[month].qty += 1;
                managers[mId].monthly[month].cases += calculatedCase;

                // C. Reason Stats (Store texts for Excel split)
                if (!reasons[reasonKey]) reasons[reasonKey] = { 
                    texts: [r1, r2, r3, r4], 
                    cases: 0.0, 
                    qty: 0 
                };
                reasons[reasonKey].qty += 1;
                reasons[reasonKey].cases += calculatedCase;

                // D. Monthly Trend
                if (!monthlyTrend[month]) monthlyTrend[month] = 0;
                monthlyTrend[month] += 1;
            });

            // Process Usage
            RAW_DATA.usage.slice(1).forEach(row => {
                const month = getMonthKey(row[0]);
                const reason = row[5] || "Unspecified";
                if (!usageReasons[reason]) usageReasons[reason] = { total: 0, monthly: {} };
                usageReasons[reason].total++;
                if (!usageReasons[reason].monthly[month]) usageReasons[reason].monthly[month] = 0;
                usageReasons[reason].monthly[month]++;
            });

            // Merge with Master Data
            ANALYZED_DATA.workers = [];
            masterRows.forEach(row => {
                const ppt = safeTrim(row[0]);
                // Skip header or empty rows
                if (!ppt || ppt.toLowerCase().includes('passport')) return;

                const comp = row[1];
                const info = workers[ppt];

                if (info) {
                    ANALYZED_DATA.workers.push({
                        Passport: ppt,
                        Company: comp,
                        Name: row[2],
                        Designation: row[3],
                        Total_Cases: Math.round(info.cases), // Rounding cases
                        Total_Qty: info.qty,
                        Used_Qty: info.usedQty,
                        Remaining_Qty: info.qty - info.usedQty,
                        Monthly_Data: info.monthly
                    });

                    if (!companies[comp]) companies[comp] = { totalQty: 0, monthly: {} };
                    companies[comp].totalQty += info.qty;
                    Object.keys(info.monthly).forEach(m => {
                        if (!companies[comp].monthly[m]) companies[comp].monthly[m] = 0;
                        companies[comp].monthly[m] += info.monthly[m].qty;
                    });
                }
            });

            ANALYZED_DATA.companies = companies;
            ANALYZED_DATA.managers = managers;
            ANALYZED_DATA.reasons = reasons;
            ANALYZED_DATA.usageReasons = usageReasons;
            ANALYZED_DATA.monthlyLabels = Array.from(monthlySet).sort();
            ANALYZED_DATA.monthlyTrend = monthlyTrend;
        }

        function renderDashboard() {
            document.getElementById('dashboard').style.display = 'block';
            
            const workers = ANALYZED_DATA.workers;
            const totalQty = workers.reduce((sum, w) => sum + w.Total_Qty, 0);
            const totalCases = workers.reduce((sum, w) => sum + w.Total_Cases, 0);
            const totalUsed = workers.reduce((sum, w) => sum + w.Used_Qty, 0);

            let monthQty = 0;
            let monthCases = 0.0;
            workers.forEach(w => {
                if (w.Monthly_Data[CURRENT_MONTH_KEY]) {
                    monthQty += w.Monthly_Data[CURRENT_MONTH_KEY].qty;
                    monthCases += w.Monthly_Data[CURRENT_MONTH_KEY].cases;
                }
            });

            document.getElementById('disp_totalQty').innerText = totalQty.toLocaleString();
            document.getElementById('disp_monthQty').innerText = `This Month: ${monthQty.toLocaleString()}`;
            
            document.getElementById('disp_totalCases').innerText = totalCases.toLocaleString();
            document.getElementById('disp_monthCases').innerText = `This Month: ${Math.round(monthCases).toLocaleString()}`;
            
            const usageRate = totalQty === 0 ? 0 : ((totalUsed / totalQty) * 100).toFixed(1);
            document.getElementById('disp_usageRate').innerText = usageRate + "%";
            document.getElementById('disp_usedCount').innerText = `Redeemed: ${totalUsed.toLocaleString()}`;
            document.getElementById('disp_activeWorkers').innerText = workers.length.toLocaleString();
            
            renderCharts();
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('workerTableBody');
            tbody.innerHTML = "";
            const sortBy = document.getElementById('sortSelect').value;
            const sorted = [...ANALYZED_DATA.workers].sort((a, b) => b[sortBy] - a[sortBy]).slice(0, 100);

            sorted.forEach(w => {
                tbody.innerHTML += `
                    <tr>
                        <td>${w.Passport}</td>
                        <td>${w.Company}</td>
                        <td>${w.Name}</td>
                        <td>${w.Total_Cases}</td>
                        <td class="fw-bold text-success">${w.Total_Qty}</td>
                        <td class="text-danger">${w.Used_Qty}</td>
                        <td class="fw-bold">${w.Remaining_Qty}</td>
                    </tr>
                `;
            });
        }

        function renderCharts() {
            const labels = ANALYZED_DATA.monthlyLabels;
            const trendData = labels.map(m => ANALYZED_DATA.monthlyTrend[m] || 0);
            
            const chartStatus = Chart.getChart("trendChart"); 
            if (chartStatus != undefined) { chartStatus.destroy(); }
            const chartCompStatus = Chart.getChart("companyChart");
            if (chartCompStatus != undefined) { chartCompStatus.destroy(); }

            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Distributed Coins (Qty)',
                        data: trendData,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true
                    }]
                }
            });

            const compEntries = Object.entries(ANALYZED_DATA.companies)
                .sort((a, b) => b[1].totalQty - a[1].totalQty)
                .slice(0, 5);
            
            new Chart(document.getElementById('companyChart'), {
                type: 'doughnut',
                data: {
                    labels: compEntries.map(x => x[0]),
                    datasets: [{
                        data: compEntries.map(x => x[1].totalQty),
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                    }]
                }
            });
        }

        // ‚ñº‚ñº‚ñº EXCEL DOWNLOAD (English Headers & 4-Column Reason Split) ‚ñº‚ñº‚ñº
        function downloadFullExcel() {
            if (ANALYZED_DATA.workers.length === 0) return alert("No data to download.");

            const wb = XLSX.utils.book_new();
            const months = ANALYZED_DATA.monthlyLabels;

            // 1. Worker Details
            const workerSheetData = ANALYZED_DATA.workers.map(w => {
                const row = {
                    "Passport": w.Passport,
                    "Company": w.Company,
                    "Name": w.Name,
                    "Designation": w.Designation,
                    "Cases (Calc)": w.Total_Cases,
                    "Total Coins (Qty)": w.Total_Qty,
                    "Redeemed Coins (Qty)": w.Used_Qty,
                    "Remaining Coins (Qty)": w.Remaining_Qty
                };
                months.forEach(m => {
                    row[`${m} (Qty)`] = w.Monthly_Data[m] ? w.Monthly_Data[m].qty : 0;
                });
                return row;
            });
            const ws1 = XLSX.utils.json_to_sheet(workerSheetData);
            XLSX.utils.book_append_sheet(wb, ws1, "Workers_Monthly");

            // 2. Company Stats
            const companySheetData = Object.keys(ANALYZED_DATA.companies).map(cName => {
                const cInfo = ANALYZED_DATA.companies[cName];
                const row = { "Company": cName, "Total Qty": cInfo.totalQty };
                months.forEach(m => {
                    row[`${m}`] = cInfo.monthly[m] || 0;
                });
                return row;
            });
            const ws2 = XLSX.utils.json_to_sheet(companySheetData);
            XLSX.utils.book_append_sheet(wb, ws2, "Company_Stats");

            // 3. Manager Performance
            const managerSheetData = Object.keys(ANALYZED_DATA.managers).map(mid => {
                const mInfo = ANALYZED_DATA.managers[mid];
                const row = { 
                    "ID": mid, "Name": mInfo.name, 
                    "Total Cases (Calc)": Math.round(mInfo.totalCases), 
                    "Total Qty": mInfo.totalQty 
                };
                months.forEach(m => {
                    row[`${m} (Qty)`] = mInfo.monthly[m] ? mInfo.monthly[m].qty : 0;
                });
                return row;
            });
            const ws3 = XLSX.utils.json_to_sheet(managerSheetData);
            XLSX.utils.book_append_sheet(wb, ws3, "Manager_Performance");

            // 4. Reason Details (‚òÖ 4 Columns Split)
            const reasonSheetData = Object.keys(ANALYZED_DATA.reasons).map(key => {
                const rData = ANALYZED_DATA.reasons[key];
                return {
                    "Top_KO": rData.texts[0],
                    "Bottom_KO": rData.texts[1],
                    "Top_EN": rData.texts[2],
                    "Bottom_EN": rData.texts[3],
                    "Frequency (Calc Cases)": Math.round(rData.cases),
                    "Distributed Coins (Total Qty)": rData.qty
                };
            });
            const ws4 = XLSX.utils.json_to_sheet(reasonSheetData);
            XLSX.utils.book_append_sheet(wb, ws4, "Reason_Details");

            // 5. Usage Stats
            const usageSheetData = Object.keys(ANALYZED_DATA.usageReasons).map(u => {
                const uInfo = ANALYZED_DATA.usageReasons[u];
                const row = { "Usage Reason": u, "Total Count": uInfo.total };
                months.forEach(m => {
                    row[`${m}`] = uInfo.monthly[m] || 0;
                });
                return row;
            });
            const ws5 = XLSX.utils.json_to_sheet(usageSheetData);
            XLSX.utils.book_append_sheet(wb, ws5, "Usage_Stats");

            XLSX.writeFile(wb, `SAY_COIN_Analysis_${CURRENT_MONTH_KEY}.xlsx`);
        }
    </script>
</body>
</html>
