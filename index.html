<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì „ ì½”ì¸ í†µí•© ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Noto Sans KR', sans-serif; }
        .dashboard-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; height: 100%; }
        .data-input-area { width: 100%; height: 200px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 10px; resize: vertical; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #0d6efd; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:none; justify-content:center; align-items:center; flex-direction:column;}
        table { font-size: 0.9rem; }
        th { background-color: #e9ecef !important; position: sticky; top: 0; }
        .table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="mt-3">ë°ì´í„° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h4>
        <p>ë°ì´í„° ì–‘ì— ë”°ë¼ ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">ğŸ›¡ï¸ ì•ˆì „ ì½”ì¸ í†µí•© ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5>ğŸ“‚ ë°ì´í„° ì…ë ¥ (Master File)</h5>
                    <p class="text-muted small mb-2">
                        ì—‘ì…€ì˜ <strong>[Passport no | Company | Name | Designation | Iqama No]</strong> 5ê°œ ì—´ì„ ë³µì‚¬í•˜ì—¬ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (2ë§Œí–‰ ì´ìƒ ê°€ëŠ¥)
                    </p>
                    <textarea id="pasteArea" class="data-input-area" placeholder="ì—¬ê¸°ì— ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê¸° (Ctrl+V) í•˜ì„¸ìš”..."></textarea>
                    <div class="d-flex justify-content-end mt-3 gap-2">
                        <button class="btn btn-secondary" onclick="clearInput()">ì´ˆê¸°í™”</button>
                        <button class="btn btn-primary px-4" onclick="processData()">ğŸ“Š ë¶„ì„ ì‹œì‘</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardArea" style="display:none;">
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="dashboard-card text-center">
                        <h6>ì´ ë¶„ì„ ì¸ì›</h6>
                        <div class="stat-value" id="val_totalWorkers">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card text-center">
                        <h6>ì´ ì§€ê¸‰ ì½”ì¸ ê°€ì¹˜</h6>
                        <div class="stat-value text-success" id="val_totalValue">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card text-center">
                        <h6>ì½”ì¸ íšŒìˆ˜ìœ¨(ì‚¬ìš©)</h6>
                        <div class="stat-value text-warning" id="val_usageRate">0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card text-center">
                        <h6>ì§€ê¸‰ ê±´ìˆ˜</h6>
                        <div class="stat-value text-info" id="val_totalLogs">0</div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <h6>ğŸ¢ ì—…ì²´ë³„ ì½”ì¸ íšë“ í˜„í™© (Top 10)</h6>
                        <canvas id="companyChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h6>ğŸ† ì§€ê¸‰ ì‚¬ìœ ë³„ ë¹ˆë„ (Top 5)</h6>
                        <canvas id="reasonChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>ğŸ“‹ ê·¼ë¡œìë³„ ìƒì„¸ ë¶„ì„ ê²°ê³¼ (ë¯¸ë¦¬ë³´ê¸°: ìƒìœ„ 100ëª…)</h6>
                            <button class="btn btn-success" onclick="downloadExcel()">
                                ğŸ“¥ ì „ì²´ ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <div class="table-wrapper">
                            <table class="table table-striped table-hover" id="resultTable">
                                <thead>
                                    <tr>
                                        <th>Passport No</th>
                                        <th>Company</th>
                                        <th>Name</th>
                                        <th>Designation</th>
                                        <th>ì§€ê¸‰ ê±´ìˆ˜</th>
                                        <th>ì´ ì½”ì¸ ê°€ì¹˜</th>
                                        <th>ì‚¬ìš© ì½”ì¸</th>
                                        <th>ì”ì—¬ ì½”ì¸</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— ë°°í¬í•œ GAS URLì„ ì…ë ¥í•˜ì„¸ìš” â–¼â–¼â–¼
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzopWOMzZTKDHvgR_n027ftHdBQSoBI1x3od2oGeAwElUT0BPfr0Tsy-rU4o8P4Yjf8/exec"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let FINAL_DATA = []; // ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš© ì „ì²´ ë°ì´í„°
        let CHART_INSTANCES = {};

        // 1. ë°ì´í„° íŒŒì‹± ë° ì²˜ë¦¬ ë©”ì¸ í•¨ìˆ˜
        async function processData() {
            const inputVal = document.getElementById('pasteArea').value;
            if (!inputVal.trim()) {
                alert("ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            document.getElementById('loading').style.display = 'flex';

            try {
                // A. ë§ˆìŠ¤í„° íŒŒì¼ íŒŒì‹± (PapaParse ì‚¬ìš©)
                // íƒ­(\t)ìœ¼ë¡œ êµ¬ë¶„ëœ ì—‘ì…€ ë°ì´í„° íŒŒì‹±
                const parsed = Papa.parse(inputVal, { delimiter: "\t", header: false });
                const masterRows = parsed.data; // 2ì°¨ì› ë°°ì—´

                // B. GASì—ì„œ Logs, Categories ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(GAS_API_URL);
                const cloudData = await response.json();
                
                // C. ë°ì´í„° ê²°í•© ë° ê³„ì‚° ì‹œì‘
                analyzeData(masterRows, cloudData.logs, cloudData.categories);

            } catch (error) {
                console.error(error);
                alert("ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // 2. ë¶„ì„ ë¡œì§ (í•µì‹¬)
        function analyzeData(masterData, logsData, categoriesData) {
            
            // [Step 1] ì¹´í…Œê³ ë¦¬ ë§µí•‘ ë§Œë“¤ê¸° (Reason Set -> Quantity)
            // Categories í—¤ë”: Top_KO, Bottom_KO, Top_EN, Bottom_EN, Quantity
            // í‚¤ ìƒì„± ë¡œì§: "Top_KO|Bottom_KO|Top_EN|Bottom_EN"
            const categoryMap = {};
            // ì²« ì¤„(í—¤ë”) ì œì™¸í•˜ê³  ìˆœíšŒ
            for(let i=1; i<categoriesData.length; i++) {
                const row = categoriesData[i];
                // ë°ì´í„°ê°€ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
                if(!row[0]) continue; 
                const key = `${row[0]}|${row[1]}|${row[2]}|${row[3]}`;
                const quantity = Number(row[4]) || 0;
                categoryMap[key] = quantity;
            }

            // [Step 2] Logs ë°ì´í„° ì§‘ê³„ (Passport No ê¸°ì¤€)
            // Logs í—¤ë” ìˆœì„œ(0ë¶€í„°): ... Passport_No(3), Coin_No(4), Top_KO(5), Bottom_KO(6), Top_EN(7), Bottom_EN(8) ...
            const logStats = {}; 
            const reasonStats = {}; // ì‚¬ìœ ë³„ ê±´ìˆ˜ í†µê³„ìš©

            for(let i=1; i<logsData.length; i++) {
                const row = logsData[i];
                const ppt = String(row[3]).trim(); // Passport No
                const coinNo = String(row[4]);
                
                // ì‚¬ìœ  Key ìƒì„±
                const reasonKey = `${row[5]}|${row[6]}|${row[7]}|${row[8]}`;
                const coinValue = categoryMap[reasonKey] || 0; // ì¹´í…Œê³ ë¦¬ ë§µì—ì„œ ê°€ì¹˜ ì°¾ê¸° (ì—†ìœ¼ë©´ 0)

                // ì‚¬ìš© ì—¬ë¶€ í™•ì¸ (Coin_Noì— '*'ê°€ í¬í•¨ë˜ë©´ ì‚¬ìš©ëœ ê²ƒ)
                const isUsed = coinNo.includes('*');

                if (!logStats[ppt]) {
                    logStats[ppt] = { count: 0, totalValue: 0, usedCount: 0 };
                }
                
                logStats[ppt].count += 1; // ì§€ê¸‰ ê±´ìˆ˜
                logStats[ppt].totalValue += coinValue; // ì½”ì¸ ê°€ì¹˜ í•©ì‚°
                if (isUsed) logStats[ppt].usedCount += 1; // ì‚¬ìš© ê°œìˆ˜

                // ì „ì²´ ì‚¬ìœ  í†µê³„ (ê±´ìˆ˜ ê¸°ì¤€)
                const reasonName = `${row[5]} (${row[6]})`; // í‘œì‹œëŠ” í•œê¸€ ìœ„ì£¼ë¡œ
                reasonStats[reasonName] = (reasonStats[reasonName] || 0) + 1;
            }

            // [Step 3] Master ë°ì´í„°ì™€ ê²°í•©
            FINAL_DATA = [];
            const companyStats = {}; // íšŒì‚¬ë³„ í†µê³„ìš©

            // masterData[0]ì€ í—¤ë”ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ. ì…ë ¥ê°’ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‚˜ ë³´í†µ ì²«ì¤„ ì œì™¸
            // ì…ë ¥ì°½ì— í—¤ë”ë¥¼ í¬í•¨í•´ì„œ ë„£ì—ˆëŠ”ì§€ ì²´í¬ í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê·¸ëƒ¥ ë‹¤ ëŒë¦¬ê³  
            // Passport í˜•ì‹ì´ ì•„ë‹Œ í–‰ì€ ìŠ¤í‚µí•˜ëŠ” ì‹ìœ¼ë¡œ ì²˜ë¦¬
            
            masterData.forEach((row, idx) => {
                if (row.length < 5) return; // ë¹ˆ ì¤„ ë¬´ì‹œ

                const ppt = String(row[0]).trim();
                const company = row[1];
                const name = row[2];
                const designation = row[3];
                const iqama = row[4];

                // í—¤ë”ì¤„ ì²˜ë¦¬ (Passportë€ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ ìŠ¤í‚µ)
                if (String(ppt).toLowerCase().includes('passport')) return;

                // Logs ì§‘ê³„ì—ì„œ ë°ì´í„° ì°¾ê¸°
                const stat = logStats[ppt] || { count: 0, totalValue: 0, usedCount: 0 };

                const rowData = {
                    Passport_No: ppt,
                    Company: company,
                    Name: name,
                    Designation: designation,
                    Iqama_No: iqama,
                    Log_Count: stat.count,
                    Total_Coin_Value: stat.totalValue,
                    Used_Coins: stat.usedCount,
                    Remaining_Coins: stat.totalValue - stat.usedCount // ì”ì•¡(ë‹¨ìˆœ ê°€ì¹˜-ì‚¬ìš©ê°œìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ ì¼ë‹¨ ë¡œì§ìƒ í‘œê¸°)
                    // ì£¼ì˜: ì‚¬ìš©ëœ ì½”ì¸ì˜ ê°€ì¹˜ë¥¼ ë¹¼ì•¼ ì •í™•í•œ ì”ì•¡ì´ì§€ë§Œ, 
                    // ì§ˆë¬¸ ë‚´ìš©ìƒ ì½”ì¸ 1ê°œ = 1ê°œ ì°¨ê° ê°œë…ì´ë©´ (Total Value - Used Count)ëŠ” ë‹¨ìœ„ê°€ ì•ˆ ë§ì„ ìˆ˜ ìˆìŒ.
                    // ì—¬ê¸°ì„œëŠ” "ë³´ìœ  ì½”ì¸ ê°œìˆ˜"ê°€ ì•„ë‹ˆë¼ "ì½”ì¸ ê°€ì¹˜" í†µê³„ì´ë¯€ë¡œ, 
                    // ì‚¬ìš©ëœ ì½”ì¸ì˜ ê°€ì¹˜ë¥¼ ì¶”ì í•  ìˆ˜ ì—†ë‹¤ë©´(Logì— ê°€ì¹˜ê°€ ì•ˆ ì í˜€ìˆìœ¼ë‹ˆ)
                    // ì”ì—¬ ì½”ì¸ ê³„ì‚°ì€ 'ê°œìˆ˜' ê¸°ì¤€ìœ¼ë¡œ í• ì§€ 'ê°€ì¹˜' ê¸°ì¤€ìœ¼ë¡œ í• ì§€ ëª¨í˜¸í•¨.
                    // -> [ìˆ˜ì •] ì§ˆë¬¸ì˜ ì˜ë„: QuantityëŠ” ì§€ê¸‰ ê°œìˆ˜. ì¦‰ Value = ê°œìˆ˜. 
                    // ë”°ë¼ì„œ (ì´ ë°›ì€ ê°œìˆ˜ - ì‚¬ìš©í•œ ê°œìˆ˜) = ì”ì—¬ ê°œìˆ˜. ì´ê²Œ ë§ìŒ.
                };
                FINAL_DATA.push(rowData);

                // íšŒì‚¬ë³„ ì§‘ê³„
                companyStats[company] = (companyStats[company] || 0) + stat.totalValue;
            });

            // [Step 4] í™”ë©´ ë Œë”ë§
            renderDashboard(FINAL_DATA, companyStats, reasonStats);
        }

        // 3. í™”ë©´ ê·¸ë¦¬ê¸° ë° ì°¨íŠ¸ ìƒì„±
        function renderDashboard(data, companyStats, reasonStats) {
            document.getElementById('dashboardArea').style.display = 'block';

            // A. ìƒë‹¨ ìš”ì•½ ì¹´ë“œ
            const totalWorkers = data.length;
            const totalValue = data.reduce((sum, item) => sum + item.Total_Coin_Value, 0);
            const totalUsed = data.reduce((sum, item) => sum + item.Used_Coins, 0);
            const totalLogs = data.reduce((sum, item) => sum + item.Log_Count, 0);
            
            // ì‚¬ìš©ë¥  ê³„ì‚° (ì§€ê¸‰ëœ ì´ ê°œìˆ˜ ëŒ€ë¹„ ì‚¬ìš©ëœ ê°œìˆ˜) -> Total Valueê°€ ê³§ ì´ ê°œìˆ˜ë¼ ê°€ì •
            const usageRate = totalValue === 0 ? 0 : ((totalUsed / totalValue) * 100).toFixed(1);

            document.getElementById('val_totalWorkers').innerText = totalWorkers.toLocaleString() + "ëª…";
            document.getElementById('val_totalValue').innerText = totalValue.toLocaleString() + "ê°œ";
            document.getElementById('val_usageRate').innerText = usageRate + "%";
            document.getElementById('val_totalLogs').innerText = totalLogs.toLocaleString() + "ê±´";

            // B. í…Œì´ë¸” ì±„ìš°ê¸° (ìƒìœ„ 100ê°œë§Œ)
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = "";
            data.slice(0, 100).forEach(row => {
                const tr = `<tr>
                    <td>${row.Passport_No}</td>
                    <td>${row.Company}</td>
                    <td>${row.Name}</td>
                    <td>${row.Designation}</td>
                    <td>${row.Log_Count}</td>
                    <td class="fw-bold">${row.Total_Coin_Value}</td>
                    <td class="text-danger">${row.Used_Coins}</td>
                    <td class="text-primary">${row.Total_Coin_Value - row.Used_Coins}</td>
                </tr>`;
                tbody.innerHTML += tr;
            });

            // C. ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            drawCharts(companyStats, reasonStats);
        }

        function drawCharts(companyStats, reasonStats) {
            // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´ (ì¬ë¶„ì„ ì‹œ)
            if (CHART_INSTANCES.company) CHART_INSTANCES.company.destroy();
            if (CHART_INSTANCES.reason) CHART_INSTANCES.reason.destroy();

            // 1. ì—…ì²´ë³„ ì°¨íŠ¸ (Top 10)
            const sortedCompany = Object.entries(companyStats)
                .sort((a, b) => b[1] - a[1]) // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                .slice(0, 10);
            
            const ctxComp = document.getElementById('companyChart').getContext('2d');
            CHART_INSTANCES.company = new Chart(ctxComp, {
                type: 'bar',
                data: {
                    labels: sortedCompany.map(x => x[0]),
                    datasets: [{
                        label: 'ì´ íšë“ ì½”ì¸ ê°œìˆ˜',
                        data: sortedCompany.map(x => x[1]),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                }
            });

            // 2. ì‚¬ìœ ë³„ ì°¨íŠ¸ (Top 5)
            const sortedReason = Object.entries(reasonStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const ctxReason = document.getElementById('reasonChart').getContext('2d');
            CHART_INSTANCES.reason = new Chart(ctxReason, {
                type: 'pie',
                data: {
                    labels: sortedReason.map(x => x[0]),
                    datasets: [{
                        data: sortedReason.map(x => x[1]),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                        ]
                    }]
                }
            });
        }

        // 4. ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        function downloadExcel() {
            if (FINAL_DATA.length === 0) {
                alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            // SheetJSë¥¼ ì‚¬ìš©í•˜ì—¬ JSON -> Excel ë³€í™˜
            const worksheet = XLSX.utils.json_to_sheet(FINAL_DATA);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ë¶„ì„ê²°ê³¼");
            
            // íŒŒì¼ëª…ì— ë‚ ì§œ ì¶”ê°€
            const dateStr = new Date().toISOString().slice(0,10);
            XLSX.writeFile(workbook, `ì•ˆì „ì½”ì¸_ë¶„ì„ê²°ê³¼_${dateStr}.xlsx`);
        }

        function clearInput() {
            document.getElementById('pasteArea').value = "";
            document.getElementById('dashboardArea').style.display = "none";
            FINAL_DATA = [];
        }
    </script>
</body>
</html>
