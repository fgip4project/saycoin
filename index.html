<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.Y COIN Secure Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="p-6">

    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                <span data-lang="title">S.A.Y COIN 보안 대시보드</span>
            </h1>
            <p class="text-gray-500 text-sm mt-1" data-lang="subtitle">서버 저장 없는 실시간 로컬 분석</p>
        </div>
        <div class="flex gap-2 flex-wrap justify-end">
            <button onclick="toggleLanguage()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow font-bold">
                <i class="fas fa-globe mr-2"></i><span id="langBtnText">EN</span>
            </button>
            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
                <i class="fas fa-sync-alt mr-2"></i><span data-lang="refresh">데이터 갱신</span>
            </button>
            <button onclick="toggleModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow">
                <i class="fas fa-paste mr-2"></i><span data-lang="btn_upload">마스터정보 입력(Session)</span>
            </button>
            <button onclick="downloadExcel()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">
                <i class="fas fa-download mr-2"></i><span data-lang="btn_download">통계 다운로드</span>
            </button>
        </div>
    </header>

    <div id="loading" class="text-center py-20">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i>
        <p class="mt-4 text-gray-600" data-lang="loading">데이터 불러오는 중...</p>
    </div>

    <div id="dashboard" class="hidden space-y-8">
        
        <div id="masterAlert" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0"><i class="fas fa-exclamation-triangle text-yellow-400"></i></div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700" data-lang="alert_msg">
                        현재 마스터 정보(이름, 소속 등)가 입력되지 않아 '미등록'으로 표시됩니다.<br>
                        우측 상단 <b>'마스터정보 입력'</b> 버튼을 눌러 엑셀 데이터를 붙여넣어 주세요. (서버 전송 X)
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="card p-6 border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm" data-lang="card_issued">총 지급 코인</p>
                <h2 class="text-3xl font-bold text-gray-800" id="totalIssued">-</h2>
            </div>
            <div class="card p-6 border-l-4 border-red-500">
                <p class="text-gray-500 text-sm" data-lang="card_used">총 사용(회수) 코인</p>
                <h2 class="text-3xl font-bold text-gray-800" id="totalUsed">-</h2>
            </div>
            <div class="card p-6 border-l-4 border-green-500">
                <p class="text-gray-500 text-sm" data-lang="card_remain">시중 유통량</p>
                <h2 class="text-3xl font-bold text-gray-800" id="currentCirculation">-</h2>
            </div>
            <div class="card p-6 border-l-4 border-purple-500">
                <p class="text-gray-500 text-sm" data-lang="card_rate">코인 회수율</p>
                <h2 class="text-3xl font-bold text-gray-800" id="returnRate">-</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_general">일반 지급 사유</h3>
                <canvas id="chartGeneral"></canvas>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_hse">HSE 지급 사유</h3>
                <canvas id="chartHSE"></canvas>
            </div>
             <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="chart_status">발행 vs 회수 비율</h3>
                <div class="h-64 flex justify-center">
                    <canvas id="chartRatio"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700" data-lang="chart_trend">협력사별 코인 지급 추세</h3>
                <span class="text-xs text-blue-500 font-bold" id="masterStatus">● Local Master Data: Empty</span>
            </div>
            <div class="h-80">
                <canvas id="chartTrend"></canvas>
            </div>
        </div>
        
        <div class="card p-6">
            <h3 class="text-lg font-bold text-gray-700 mb-4" data-lang="table_title">협력사 코인 잔액 (Subcon_Logs)</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3" data-lang="th_name">협력사명</th>
                            <th class="px-6 py-3 text-right" data-lang="th_give">총 지급</th>
                            <th class="px-6 py-3 text-right" data-lang="th_use">총 사용</th>
                            <th class="px-6 py-3 text-right font-bold" data-lang="th_balance">현재 잔액</th>
                        </tr>
                    </thead>
                    <tbody id="subconTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold" data-lang="modal_title">마스터 정보 입력 (세션 전용)</p>
                    <div class="cursor-pointer z-50" onclick="toggleModal()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="bg-blue-50 p-3 rounded mb-3 text-sm text-blue-800">
                    <i class="fas fa-lock mr-2"></i>
                    <span data-lang="modal_security">이 데이터는 서버로 전송되지 않고 브라우저에서만 사용됩니다.</span>
                </div>
                <p class="text-sm text-gray-500 mb-2" data-lang="modal_desc">
                    엑셀의 [Passport, Company, Name, Designation] 4개 열을 복사해 붙여넣으세요.
                </p>
                <textarea id="pasteArea" class="w-full h-64 p-2 border rounded bg-gray-50 text-xs font-mono" placeholder="A1234567 | SEC | Hong Gil Dong | Manager&#10;..."></textarea>
                <div class="flex justify-end pt-4 gap-2">
                    <button onclick="toggleModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" data-lang="btn_close">닫기</button>
                    <button onclick="applyMasterData()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" data-lang="btn_apply">적용하기</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [설정] 배포된 GAS URL (exec로 끝나는 주소)
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxVF66kP7qUr092RVdsXctYztfGVtszSuWJmLKa9Ak6-FTR47jgoLif9EYbC-xaFYGo/exec"; 

        // 전역 상태
        let currentLang = 'ko';
        let cachedData = null;      // 서버에서 가져온 GAS 데이터 (Logs, Usage...)
        let localMasterMap = {};    // 브라우저에 붙여넣은 로컬 마스터 데이터 { "Passport": {info...} }
        let charts = {};

        const t = {
            title: { ko: "S.A.Y COIN 보안 대시보드", en: "S.A.Y COIN Secure Dashboard" },
            subtitle: { ko: "서버 저장 없는 실시간 로컬 분석", en: "Client-side Analysis (No Server Storage)" },
            refresh: { ko: "데이터 갱신", en: "Refresh Data" },
            btn_upload: { ko: "마스터정보 입력(Session)", en: "Input Master Data" },
            btn_download: { ko: "통계 다운로드", en: "Download Excel" },
            loading: { ko: "데이터 불러오는 중...", en: "Loading..." },
            alert_msg: { ko: "현재 마스터 정보(이름, 소속 등)가 입력되지 않아 '미등록'으로 표시됩니다.<br>우측 상단 <b>'마스터정보 입력'</b> 버튼을 눌러 엑셀 데이터를 붙여넣어 주세요. (서버 전송 X)", en: "Master data is missing. Charts will show 'Unregistered'.<br>Please click <b>'Input Master Data'</b> to paste Excel data locally." },
            
            // Cards
            card_issued: { ko: "총 지급 코인", en: "Total Issued" },
            card_used: { ko: "총 사용(회수) 코인", en: "Total Redeemed" },
            card_remain: { ko: "시중 유통량", en: "Circulation" },
            card_rate: { ko: "코인 회수율", en: "Redemption Rate" },
            
            // Charts
            chart_general: { ko: "일반 지급 사유", en: "Issued by Reason (General)" },
            chart_hse: { ko: "HSE 지급 사유", en: "Issued by Reason (HSE)" },
            chart_status: { ko: "발행 vs 회수 비율", en: "Issued vs Redeemed" },
            chart_trend: { ko: "협력사별 코인 지급 추세", en: "Monthly Trend by Company" },
            
            // Table
            table_title: { ko: "협력사 코인 잔액 (Subcon_Logs)", en: "Subcontractor Coin Balance" },
            th_name: { ko: "협력사명", en: "Company" },
            th_give: { ko: "총 지급", en: "Given" },
            th_use: { ko: "총 사용", en: "Used" },
            th_balance: { ko: "잔액", en: "Balance" },
            
            // Modal
            modal_title: { ko: "마스터 정보 입력 (세션 전용)", en: "Input Master Data (Session Only)" },
            modal_security: { ko: "이 데이터는 서버로 전송되지 않고 브라우저에서만 사용됩니다.", en: "Data is processed locally in your browser. Not sent to server." },
            modal_desc: { ko: "엑셀의 [Passport, Company, Name, Designation] 4개 열을 복사해 붙여넣으세요.", en: "Paste [Passport, Company, Name, Designation] columns here." },
            btn_close: { ko: "닫기", en: "Close" },
            btn_apply: { ko: "적용하기", en: "Apply Data" }
        };

        window.onload = function() { applyLanguage(); fetchData(); };

        function toggleLanguage() {
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            document.getElementById('langBtnText').innerText = currentLang === 'ko' ? 'EN' : 'KO';
            applyLanguage();
            if (cachedData) processAndRender(cachedData);
        }

        function applyLanguage() {
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (t[key]) el.innerHTML = t[key][currentLang];
            });
        }

        function toggleModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }

        // 1. 데이터 가져오기 (Logs, Usage 등만 가져옴)
        async function fetchData() {
            if (GAS_URL.includes("YOUR_GAS")) return alert("GAS URL을 설정해주세요.");
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            try {
                const res = await fetch(GAS_URL);
                const json = await res.json();
                if (json.status === 'success') {
                    cachedData = json.data;
                    processAndRender(cachedData);
                }
            } catch (e) { console.error(e); alert("데이터 로드 실패"); } 
            finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            }
        }

        // 2. [로컬] 마스터 데이터 적용 (서버 전송 없음!)
        function applyMasterData() {
            const rawText = document.getElementById('pasteArea').value.trim();
            if (!rawText) return alert("데이터를 입력하세요.");
            const rows = rawText.split('\n').map(line => line.split('\t').map(c => c.trim()));
            
            if (rows.length === 0 || rows[0].length < 4) return alert("최소 4개 열(Passport, Company, Name, Designation)이 필요합니다.");
            
            // 로컬 변수에 저장
            let count = 0;
            localMasterMap = {}; // 초기화
            rows.forEach(r => {
                if(r[0]) {
                    localMasterMap[r[0]] = { company: r[1], name: r[2], desig: r[3] };
                    count++;
                }
            });

            alert(`${count}명의 정보를 브라우저에 적용했습니다.\n(새로고침 시 초기화됩니다)`);
            
            // 상태 표시 업데이트
            document.getElementById('masterStatus').innerText = `● Local Master Data: ${count} entries loaded`;
            document.getElementById('masterStatus').className = "text-xs text-green-600 font-bold";
            document.getElementById('masterAlert').classList.add('hidden'); // 경고 배너 숨기기
            
            toggleModal();
            processAndRender(cachedData); // 차트 다시 그리기
        }

        // 3. 데이터 병합 및 시각화
        function processAndRender(data) {
            const { logs, usage, subcon, categories } = data; // master는 없음
            
            const totalIssued = logs.length;
            const totalUsed = usage.length;
            const remaining = totalIssued - totalUsed;
            const rate = totalIssued > 0 ? ((totalUsed / totalIssued) * 100).toFixed(1) + "%" : "0%";

            document.getElementById('totalIssued').innerText = totalIssued.toLocaleString();
            document.getElementById('totalUsed').innerText = totalUsed.toLocaleString();
            document.getElementById('currentCirculation').innerText = remaining.toLocaleString();
            document.getElementById('returnRate').innerText = rate;

            const permMap = {};
            categories.forEach(row => { if (row[1]) permMap[row[1]] = row[5]; });

            const reasonGeneral = {}, reasonHSE = {}, companyTrend = {};

            logs.forEach(row => {
                const ts = new Date(row[0]);
                const passport = row[3]; // D열
                const reason = row[6];   // G열
                
                // 사유별 집계
                if (permMap[reason] === 'Master') reasonHSE[reason] = (reasonHSE[reason] || 0) + 1;
                else reasonGeneral[reason] = (reasonGeneral[reason] || 0) + 1;

                // [핵심] 로컬 마스터 데이터와 매칭
                let comp = 'Unregistered';
                if (localMasterMap[passport]) {
                    comp = localMasterMap[passport].company || 'Unknown';
                }
                
                // 추세 집계
                const yyyymm = ts.toISOString().slice(0, 7);
                if (!companyTrend[comp]) companyTrend[comp] = {};
                companyTrend[comp][yyyymm] = (companyTrend[comp][yyyymm] || 0) + 1;
            });

            drawBarChart('chartGeneral', reasonGeneral, 'rgba(59, 130, 246, 0.7)');
            drawBarChart('chartHSE', reasonHSE, 'rgba(239, 68, 68, 0.7)');
            drawPieChart('chartRatio', totalUsed, remaining);
            drawLineChart('chartTrend', companyTrend);
            drawSubconTable(subcon);
        }

        // 4. 엑셀 다운로드 (로컬 데이터 병합)
        function downloadExcel() {
            if (!cachedData) return alert("데이터 없음");
            
            const { logs, subcon } = cachedData;
            const wb = XLSX.utils.book_new();

            // 시트 1: 상세 내역
            const rawSheetData = logs.map(row => {
                const passport = row[3];
                const info = localMasterMap[passport] || { company: "미등록", name: "미등록", desig: "-" };
                const date = new Date(row[0]);
                
                return {
                    "지급일시": row[0],
                    "년-월": `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`,
                    "관리자": row[2],
                    "여권번호": passport,
                    "이름": info.name,
                    "협력사": info.company,
                    "직책": info.desig,
                    "코인번호": row[4],
                    "사유": row[6]
                };
            });
            const wsRaw = XLSX.utils.json_to_sheet(rawSheetData);
            XLSX.utils.book_append_sheet(wb, wsRaw, "전체_상세_내역");

            // 시트 2: 월별 통계
            const pivotData = {}; 
            const allMonths = new Set();
            rawSheetData.forEach(item => {
                const comp = item["협력사"];
                const ym = item["년-월"];
                if (!pivotData[comp]) pivotData[comp] = {};
                pivotData[comp][ym] = (pivotData[comp][ym] || 0) + 1;
                allMonths.add(ym);
            });
            const sortedMonths = Array.from(allMonths).sort();
            const monthlySheetData = [];
            Object.keys(pivotData).forEach(comp => {
                const rowObj = { "협력사명": comp };
                let sum = 0;
                sortedMonths.forEach(ym => {
                    const val = pivotData[comp][ym] || 0;
                    rowObj[ym] = val;
                    sum += val;
                });
                rowObj["총합계"] = sum;
                monthlySheetData.push(rowObj);
            });
            const wsMonthly = XLSX.utils.json_to_sheet(monthlySheetData);
            XLSX.utils.book_append_sheet(wb, wsMonthly, "월별_통계");

            // 시트 3: 협력사 잔액
            const subconStats = {};
            subcon.forEach(row => {
                const name = row[2], type = row[3], qty = Number(row[4]) || 0;
                if (!subconStats[name]) subconStats[name] = { give: 0, use: 0 };
                if (type === 'Give') subconStats[name].give += qty;
                else if (type === 'Use') subconStats[name].use += qty;
            });
            const subconSheetData = Object.keys(subconStats).map(name => {
                const s = subconStats[name];
                return { "협력사명": name, "지급": s.give, "사용": s.use, "잔액": s.give - s.use };
            });
            const wsSubcon = XLSX.utils.json_to_sheet(subconSheetData);
            XLSX.utils.book_append_sheet(wb, wsSubcon, "협력사_잔액");

            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            XLSX.writeFile(wb, `SAY_COIN_통계_${dateStr}.xlsx`);
        }

        // --- Chart Helpers (동일) ---
        function getTopKeys(obj, limit = 5) {
            return Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, limit);
        }
        function drawBarChart(id, data, color) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            const sorted = getTopKeys(data, 10);
            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: { labels: sorted.map(i => i[0]), datasets: [{ label: 'Count', data: sorted.map(i => i[1]), backgroundColor: color, borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
            });
        }
        function drawPieChart(id, used, remaining) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Redeemed', 'Active'], datasets: [{ data: [used, remaining], backgroundColor: ['#EF4444', '#10B981'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        function drawLineChart(id, trendData) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            const allMonths = new Set();
            Object.values(trendData).forEach(m => Object.keys(m).forEach(k => allMonths.add(k)));
            const labels = Array.from(allMonths).sort();
            const datasets = Object.keys(trendData).map((comp, idx) => {
                const hue = (idx * 137.5) % 360;
                return { label: comp, data: labels.map(m => trendData[comp][m] || 0), borderColor: `hsl(${hue}, 70%, 50%)`, backgroundColor: `hsl(${hue}, 70%, 50%)`, tension: 0.3, pointRadius: 3 };
            });
            charts[id] = new Chart(ctx, {
                type: 'line', data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
            });
        }
        function drawSubconTable(subconData) {
            const subconStats = {}; 
            subconData.forEach(row => {
                const name = row[2], type = row[3], qty = Number(row[4]) || 0;
                if (!subconStats[name]) subconStats[name] = { give: 0, use: 0 };
                if (type === 'Give') subconStats[name].give += qty;
                else if (type === 'Use') subconStats[name].use += qty;
            });
            const tbody = document.getElementById('subconTableBody');
            tbody.innerHTML = '';
            Object.keys(subconStats).forEach(name => {
                const s = subconStats[name], balance = s.give - s.use;
                tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${name}</td><td class="px-6 py-4 text-right text-blue-600">+${s.give.toLocaleString()}</td><td class="px-6 py-4 text-right text-red-600">-${s.use.toLocaleString()}</td><td class="px-6 py-4 text-right font-bold">${balance.toLocaleString()}</td></tr>`;
            });
        }
    </script>
</body>
</html>
